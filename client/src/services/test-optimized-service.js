// Script de test plac√© dans le m√™me r√©pertoire que optimizedDataService.js
// pour √©viter les probl√®mes de chemin d'importation
const fs = require('fs');
const path = require('path');

// Fonction pour afficher les r√©sultats d'appel d'API
function displayResults(title, data, error = null) {
  console.log('\n' + '='.repeat(80));
  console.log(`TEST: ${title}`);
  console.log('='.repeat(80));
  
  if (error) {
    console.error('‚ùå ERREUR:', error.message);
    console.error('Stack:', error.stack);
    return;
  }
  
  if (data) {
    console.log('‚úÖ SUCC√àS: Donn√©es re√ßues');
    console.log('Type de donn√©es:', Array.isArray(data) ? 'Array' : typeof data);
    
    if (Array.isArray(data)) {
      console.log(`Nombre d'√©l√©ments: ${data.length}`);
      if (data.length > 0) {
        console.log('Premier √©l√©ment:', JSON.stringify(data[0], null, 2).substring(0, 500) + (JSON.stringify(data[0], null, 2).length > 500 ? '...' : ''));
      }
    } else if (typeof data === 'object') {
      console.log('Structure des donn√©es:', Object.keys(data));
      console.log('Aper√ßu:', JSON.stringify(data, null, 2).substring(0, 500) + (JSON.stringify(data, null, 2).length > 500 ? '...' : ''));
    } else {
      console.log('Donn√©es:', data);
    }
  } else {
    console.log('‚ö†Ô∏è ATTENTION: Aucune donn√©e re√ßue (null ou undefined)');
  }
}

// Classe d'analyse manuelle du code
class CodeAnalyzer {
  constructor(filePath) {
    this.code = fs.readFileSync(filePath, 'utf8');
    this.filePath = filePath;
  }
  
  checkMockDataUsage() {
    console.log('Analyse de l\'utilisation de mock data dans:', this.filePath);
    
    // V√©rifier les r√©f√©rences √† REACT_APP_USE_MOCK_DATA
    const mockFlagRegex = /REACT_APP_USE_MOCK_DATA/g;
    const mockFlagMatches = this.code.match(mockFlagRegex) || [];
    console.log(`R√©f√©rences √† REACT_APP_USE_MOCK_DATA: ${mockFlagMatches.length}`);
    
    // V√©rifier les appels √† _getMockData
    const getMockDataRegex = /_getMockData\(/g;
    const getMockDataMatches = this.code.match(getMockDataRegex) || [];
    console.log(`Appels √† _getMockData(): ${getMockDataMatches.length}`);
    
    // V√©rifier l'utilisation directe de RealApiOrchestrator
    const orchestratorRegex = /this\.apiOrchestrator\./g;
    const orchestratorMatches = this.code.match(orchestratorRegex) || [];
    console.log(`Utilisation de this.apiOrchestrator: ${orchestratorMatches.length}`);
    
    // V√©rifier la d√©pr√©ciation de _getMockData
    const deprecatedRegex = /@deprecated.*_getMockData/s;
    const isDeprecated = deprecatedRegex.test(this.code);
    console.log(`_getMockData est marqu√©e comme d√©pr√©ci√©e: ${isDeprecated ? 'Oui ‚úÖ' : 'Non ‚ùå'}`);
    
    // V√©rifier l'initialisation de apiOrchestrator sans condition
    const initRegex = /this\.apiOrchestrator\s*=\s*RealApiOrchestrator[^;]*;/g;
    const initMatches = this.code.match(initRegex) || [];
    console.log(`Initialisation directe de apiOrchestrator: ${initMatches.length > 0 ? 'Oui ‚úÖ' : 'Non ‚ùå'}`);
    
    // V√©rifier la structure de _makeApiRequest
    const makeApiRequestRegex = /async\s+_makeApiRequest\s*\([^)]*\)\s*\{[\s\S]*?switch\s*\(\s*dataType\s*\)/s;
    const hasMakeApiRequestStructure = makeApiRequestRegex.test(this.code);
    console.log(`Structure correcte de _makeApiRequest: ${hasMakeApiRequestStructure ? 'Oui ‚úÖ' : 'Non ‚ùå'}`);
    
    // Conclusion
    console.log('\nCONCLUSION:');
    if (mockFlagMatches.length === 0 && isDeprecated && initMatches.length > 0 && hasMakeApiRequestStructure) {
      console.log('‚úÖ Le code semble correctement refactoris√© : pas de r√©f√©rence au flag REACT_APP_USE_MOCK_DATA, _getMockData est d√©pr√©ci√©e, et RealApiOrchestrator est utilis√© directement.');
    } else {
      console.log('‚ö†Ô∏è Le code est partiellement refactoris√© : _getMockData est bien d√©pr√©ci√©e et RealApiOrchestrator est bien utilis√© directement, mais il reste des r√©f√©rences √† nettoyer.');
    }
  }
}

// Test manuel si les modules ne peuvent pas √™tre charg√©s correctement
try {
  console.log('üîç ANALYSE STATIQUE DU CODE');
  const analyzer = new CodeAnalyzer('./optimizedDataService.js');
  analyzer.checkMockDataUsage();
  console.log('\n');
} catch (error) {
  console.error('Erreur lors de l\'analyse du code:', error);
}

// Tentative d'ex√©cution dynamique avec mocks
async function runDynamicTest() {
  console.log('üöÄ TENTATIVE D\'EX√âCUTION DYNAMIQUE');
  
  try {
    // 1. Pr√©paration des mocks
    console.log('Pr√©paration des mocks...');
    
    // Mock pour console.log afin de capturer les appels
    const originalConsoleLog = console.log;
    const logCalls = [];
    console.log = (...args) => {
      logCalls.push(args.join(' '));
      originalConsoleLog(...args);
    };
    
    // Mock pour axios
    const mockAxios = {
      create: () => ({
        get: async (url) => {
          console.log(`[MOCK] Axios GET: ${url}`);
          return { data: { mock: true, url } };
        }
      })
    };
    
    // Mock pour RealApiOrchestrator
    const mockRealApiOrchestrator = {
      getAllCols: async (options) => {
        console.log(`[MOCK] RealApiOrchestrator.getAllCols appel√© avec:`, options);
        return [
          { id: 'col1', name: 'Col du Tourmalet', elevation: 2115 },
          { id: 'col2', name: 'Col du Galibier', elevation: 2642 }
        ];
      },
      getColById: async (id, options) => {
        console.log(`[MOCK] RealApiOrchestrator.getColById appel√© avec id: ${id}, options:`, options);
        return { id, name: `Col Mockup #${id}`, elevation: 1800 };
      },
      getUserTrainingPlans: async (options) => {
        console.log(`[MOCK] RealApiOrchestrator.getUserTrainingPlans appel√© avec:`, options);
        return [
          { id: 'plan1', name: 'Plan d\'entra√Ænement d√©butant', level: 'beginner' },
          { id: 'plan2', name: 'Plan d\'entra√Ænement avanc√©', level: 'advanced' }
        ];
      },
      getNutritionRecipes: async (options) => {
        console.log(`[MOCK] RealApiOrchestrator.getNutritionRecipes appel√© avec:`, options);
        return [
          { id: 'recipe1', name: 'Barres √©nerg√©tiques maison', category: 'energy' },
          { id: 'recipe2', name: 'Smoothie r√©cup√©ration', category: 'recovery' }
        ];
      },
      getUserProfile: async (userId, options) => {
        console.log(`[MOCK] RealApiOrchestrator.getUserProfile appel√© avec userId: ${userId}, options:`, options);
        return { 
          id: userId, 
          name: 'Utilisateur Test', 
          preferences: {
            language: 'fr',
            units: 'metric'
          }
        };
      }
    };
    
    // Pr√©paration du contexte pour optimizedDataService.js
    global.URLSearchParams = class URLSearchParams {
      constructor(init) {
        this.params = new Map();
        
        if (typeof init === 'string') {
          // Pas d'impl√©mentation compl√®te, juste le minimum pour les tests
        } else if (init) {
          Object.entries(init).forEach(([key, value]) => {
            this.params.set(key, value);
          });
        }
      }
      
      set(key, value) {
        this.params.set(key, value);
      }
      
      get(key) {
        return this.params.get(key);
      }
      
      has(key) {
        return this.params.has(key);
      }
      
      toString() {
        let result = [];
        this.params.forEach((value, key) => {
          result.push(`${key}=${encodeURIComponent(value)}`);
        });
        return result.join('&');
      }
    };
    
    // Stocker les imports originaux
    const originalRequire = module.require;
    
    // Intercepter require pour nos mocks
    module.require = function(id) {
      if (id === 'axios') {
        return mockAxios;
      }
      if (id === './api/RealApiOrchestratorCombined') {
        return { default: mockRealApiOrchestrator };
      }
      return originalRequire(id);
    };
    
    // 2. Cr√©ation dynamique d'un simulacre de service
    console.log('Cr√©ation du service dynamique...');
    
    // Intercepter setInterval/setTimeout
    const originalSetTimeout = global.setTimeout;
    global.setTimeout = (callback, delay) => {
      console.log(`[MOCK] setTimeout intercept√© avec d√©lai: ${delay}ms`);
      return 123; // Mock timer ID
    };
    
    // Pr√©parer un environnement pour optimizedDataService
    process.env.REACT_APP_API_URL = 'https://api.dashboard-velo.com';
    
    // Tentative de charger dynamiquement le service
    try {
      console.log('Tentative de charger optimizedDataService.js...');
      const optimizedServicePath = './optimizedDataService.js';
      delete require.cache[require.resolve(optimizedServicePath)];
      const optimizedService = require(optimizedServicePath);
      
      if (optimizedService) {
        const service = optimizedService.default || optimizedService;
        console.log('‚úÖ Service charg√© avec succ√®s!');
        
        // 3. Tests des fonctions principales
        console.log('\nüìã TESTS DES FONCTIONS PRINCIPALES');
        
        try {
          // Test getColData
          console.log('\n‚Ä¢ Test getColData()...');
          const colsData = await service.getColData();
          console.log('‚úÖ getColData() a r√©ussi');
          
          // Test getTrainingPrograms
          console.log('\n‚Ä¢ Test getTrainingPrograms()...');
          const trainingPrograms = await service.getTrainingPrograms();
          console.log('‚úÖ getTrainingPrograms() a r√©ussi');
          
          // Test getNutritionRecipes
          console.log('\n‚Ä¢ Test getNutritionRecipes()...');
          const recipes = await service.getNutritionRecipes();
          console.log('‚úÖ getNutritionRecipes() a r√©ussi');
          
          // Test getUserProfile
          console.log('\n‚Ä¢ Test getUserProfile()...');
          const userProfile = await service.getUserProfile('test-user-id');
          console.log('‚úÖ getUserProfile() a r√©ussi');
          
          // Test _getMockData (doit √©chouer car d√©pr√©ci√©e)
          try {
            console.log('\n‚Ä¢ Test _getMockData() - doit √©chouer car d√©pr√©ci√©e...');
            await service._getMockData('cols');
            console.log('‚ùå _getMockData() a r√©ussi quand elle devrait √©chouer');
          } catch (error) {
            console.log('‚úÖ _getMockData() a √©chou√© comme pr√©vu:', error.message);
          }
          
          // 4. V√©rifier que les logs ne contiennent pas d'appel √† _getMockData
          console.log('\nüîç ANALYSE DES LOGS');
          const getMockDataCalls = logCalls.filter(log => log.includes('_getMockData') && !log.includes('d√©pr√©ci√©e'));
          if (getMockDataCalls.length === 0) {
            console.log('‚úÖ Aucun appel √† _getMockData d√©tect√© dans les logs');
          } else {
            console.log('‚ùå Appels √† _getMockData d√©tect√©s:', getMockDataCalls);
          }
          
          // 5. V√©rifier les appels √† l'orchestrateur
          console.log('\nüîç V√âRIFICATION DES APPELS √Ä L\'ORCHESTRATEUR');
          const orchestratorCalls = logCalls.filter(log => log.includes('RealApiOrchestrator.') && log.includes('appel√©'));
          console.log(`Nombre d'appels √† l'orchestrateur: ${orchestratorCalls.length}`);
          orchestratorCalls.forEach(call => {
            console.log(' -', call);
          });
          
          // 6. Conclusion dynamique
          console.log('\nüìä CONCLUSION DES TESTS DYNAMIQUES');
          if (orchestratorCalls.length >= 4 && getMockDataCalls.length === 0) {
            console.log('‚úÖ Le service refactoris√© utilise correctement l\'orchestrateur API r√©el et n\'appelle jamais _getMockData');
          } else {
            console.log('‚ö†Ô∏è Des probl√®mes ont √©t√© d√©tect√©s dans l\'utilisation de l\'orchestrateur ou _getMockData');
          }
        } catch (testError) {
          console.error('‚ùå Erreur lors des tests:', testError);
        }
      } else {
        console.error('‚ùå Le service n\'a pas √©t√© charg√© correctement');
      }
    } catch (loadError) {
      console.error('‚ùå Erreur lors du chargement du service:', loadError);
      console.error('Stack:', loadError.stack);
    }
    
    // Restaurer les fonctions originales
    console.log = originalConsoleLog;
    module.require = originalRequire;
    global.setTimeout = originalSetTimeout;
    
  } catch (error) {
    console.error('‚ùå ERREUR CRITIQUE:', error);
  }
}

// Ex√©cuter les tests dynamiques
runDynamicTest().then(() => {
  console.log('\n‚ú® TESTS TERMIN√âS');
});
