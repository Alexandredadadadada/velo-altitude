"use strict";(self.webpackChunkgrand_est_cyclisme_client=self.webpackChunkgrand_est_cyclisme_client||[]).push([[5918],{65918:(e,t,n)=>{n.d(t,{As:()=>k});var r=n(65043),o=n(54420),i=n(51238),s=n(62435);const a=new class{constructor(){this.fingerprintKey="client_fingerprint",this.uaParser=new s,this.initFingerprint()}initFingerprint(){this.getFingerprint()||this.generateFingerprint()}generateFingerprint(){const e={id:(0,i.A)(),browser:this.getBrowserInfo(),os:this.getOSInfo(),screen:this.getScreenInfo(),timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone,languages:navigator.languages||[navigator.language||navigator.userLanguage],hardware:this.getHardwareInfo(),capabilities:this.getCapabilities(),createdAt:(new Date).toISOString()};return localStorage.setItem(this.fingerprintKey,JSON.stringify(e)),e}getFingerprint(){const e=localStorage.getItem(this.fingerprintKey);return e?JSON.parse(e):null}getFingerprintId(){const e=this.getFingerprint();return e?e.id:null}updateFingerprint(){const e=this.getFingerprint();if(!e)return this.generateFingerprint();const t={...this.generateFingerprint(),id:e.id,previousCreatedAt:e.createdAt,updatedAt:(new Date).toISOString()};return localStorage.setItem(this.fingerprintKey,JSON.stringify(t)),t}getBrowserInfo(){const e=this.uaParser.getBrowser(),t=this.uaParser.getEngine();return{name:e.name||"Unknown",version:e.version||"Unknown",engine:t.name||"Unknown",engineVersion:t.version||"Unknown",userAgent:navigator.userAgent}}getOSInfo(){const e=this.uaParser.getOS();return{name:e.name||"Unknown",version:e.version||"Unknown",platform:navigator.platform||"Unknown"}}getScreenInfo(){return{width:window.screen.width,height:window.screen.height,colorDepth:window.screen.colorDepth,pixelRatio:window.devicePixelRatio||1,orientation:window.screen.orientation?window.screen.orientation.type:"Unknown"}}getHardwareInfo(){const e=this.uaParser.getDevice(),t={deviceType:e.type||"Unknown",deviceModel:e.model||"Unknown",deviceVendor:e.vendor||"Unknown",isMobile:this.isMobileDevice(),isTablet:this.isTabletDevice()};return navigator.hardwareConcurrency&&(t.cpuCores=navigator.hardwareConcurrency),navigator.deviceMemory&&(t.deviceMemory=navigator.deviceMemory),t}isMobileDevice(){return"mobile"===this.uaParser.getDevice().type||/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(navigator.userAgent)}isTabletDevice(){return"tablet"===this.uaParser.getDevice().type||/(tablet|ipad|playbook|silk)|(android(?!.*mobile))/i.test(navigator.userAgent)}getCapabilities(){const e={cookies:navigator.cookieEnabled,localStorage:this.isLocalStorageEnabled(),sessionStorage:this.isSessionStorageEnabled(),webGL:this.isWebGLEnabled(),webRTC:this.isWebRTCEnabled(),canvas:this.isCanvasEnabled(),svg:this.isSVGEnabled(),webP:null,audio:this.isAudioEnabled(),video:this.isVideoEnabled(),touchPoints:"maxTouchPoints"in navigator?navigator.maxTouchPoints:0,bluetooth:"bluetooth"in navigator,gyroscope:this.hasGyroscope(),serviceWorkers:"serviceWorker"in navigator};return this.testWebPSupport().then((t=>{e.webP=t;const n=this.getFingerprint();n&&(n.capabilities={...n.capabilities,webP:t},localStorage.setItem(this.fingerprintKey,JSON.stringify(n)))})),e}isLocalStorageEnabled(){try{return localStorage.setItem("test","test"),localStorage.removeItem("test"),!0}catch(e){return!1}}isSessionStorageEnabled(){try{return sessionStorage.setItem("test","test"),sessionStorage.removeItem("test"),!0}catch(e){return!1}}isWebGLEnabled(){try{const e=document.createElement("canvas");return!(!window.WebGLRenderingContext||!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}catch(e){return!1}}isWebRTCEnabled(){return!(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)||!!navigator.getUserMedia||!!navigator.webkitGetUserMedia||!!navigator.mozGetUserMedia}isCanvasEnabled(){try{const e=document.createElement("canvas");return!(!e.getContext||!e.getContext("2d"))}catch(e){return!1}}isSVGEnabled(){return!!document.createElementNS&&!!document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGRect}testWebPSupport(){return new Promise((e=>{const t=new Image;t.onload=t.onerror=function(){e(2===t.height)},t.src="data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAACyAgCdASoCAAIALmk0mk0iIiIiIgBoSygABc6WWgAA/veff/0PP8bA//LwYAAA"}))}isAudioEnabled(){return!!(window.AudioContext||window.webkitAudioContext||window.mozAudioContext)}isVideoEnabled(){try{return!!document.createElement("video").canPlayType}catch(e){return!1}}hasGyroscope(){return"DeviceOrientationEvent"in window||"DeviceMotionEvent"in window}getAuthFingerprint(){const e=this.getFingerprint()||this.generateFingerprint();return{id:e.id,browser:`${e.browser.name}/${e.browser.version}`,os:`${e.os.name}/${e.os.version}`,screen:`${e.screen.width}x${e.screen.height}`,isMobile:e.hardware.isMobile,timeZone:e.timeZone,language:e.languages[0]||"unknown"}}};class c extends Error{constructor(e,t){super(e),this.name="AuthError",this.code=t}}class h{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"auth_";this.prefix=e}async getAccessToken(){return localStorage.getItem(`${this.prefix}access_token`)}async getRefreshToken(){return localStorage.getItem(`${this.prefix}refresh_token`)}async setTokens(e,t){localStorage.setItem(`${this.prefix}access_token`,e),localStorage.setItem(`${this.prefix}refresh_token`,t)}async clearTokens(){localStorage.removeItem(`${this.prefix}access_token`),localStorage.removeItem(`${this.prefix}refresh_token`)}}new class{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.baseUrl=e.baseUrl||"/api/auth",this.tokenStorage=e.tokenStorage||new h,this.refreshThreshold=e.refreshThreshold||300,this.graceEnabled=!1!==e.graceEnabled,this.onSessionExpired=e.onSessionExpired||(()=>{window.dispatchEvent(new CustomEvent("auth:session-expired"))}),this.onTokenRevoked=e.onTokenRevoked||(()=>{window.dispatchEvent(new CustomEvent("auth:token-revoked"))}),this.refreshInterval=setInterval((()=>{this.checkAndRefreshToken()}),1e3*(e.refreshCheckInterval||60))}async login(e){try{const t=a.getAuthFingerprint(),n={...e,clientFingerprint:t},r=await fetch(`${this.baseUrl}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!r.ok){const e=await r.json();throw new c(e.message,e.code)}const o=await r.json();return await this.tokenStorage.setTokens(o.accessToken,o.refreshToken),o.user}catch(t){throw console.error("Login failed:",t),t}}async logout(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];try{const t=await this.tokenStorage.getRefreshToken();t&&await fetch(`${this.baseUrl}/logout`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${await this.tokenStorage.getAccessToken()}`},body:JSON.stringify({refreshToken:t,revokeAll:e,clientFingerprint:a.getFingerprintId()})})}catch(t){console.warn("Error during logout:",t)}finally{await this.tokenStorage.clearTokens(),clearInterval(this.refreshInterval)}}async getAuthenticatedFetch(){var e=this;const t=await this.tokenStorage.getAccessToken();if(!t)throw new c("No access token available","no_token");return async function(n){const r={...arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}};r.headers={...r.headers,Authorization:`Bearer ${t}`};const o=a.getFingerprintId();o&&(r.headers["X-Client-ID"]=o);try{const t=await fetch(n,r);if(401===t.status||403===t.status){let o;try{o=await t.json()}catch(i){o={message:"Authentication error",code:"auth_error"}}if("token_expired"===o.code&&e.graceEnabled)try{const t=await e.refreshToken();if(t)return r.headers.Authorization=`Bearer ${t}`,fetch(n,r)}catch(s){console.error("Failed to refresh token during grace period:",s)}throw new c(o.message,o.code)}return t}catch(h){throw h instanceof c&&("token_revoked"===h.code?(await e.tokenStorage.clearTokens(),e.onTokenRevoked()):"session_expired"!==h.code&&"invalid_token"!==h.code||(await e.tokenStorage.clearTokens(),e.onSessionExpired())),h}}}async refreshToken(){try{const e=await this.tokenStorage.getRefreshToken();if(!e)throw new c("No refresh token available","no_refresh_token");const t=a.getAuthFingerprint(),n=await fetch(`${this.baseUrl}/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refreshToken:e,clientFingerprint:t})});if(!n.ok){const e=await n.json();throw new c(e.message,e.code)}const r=await n.json();return await this.tokenStorage.setTokens(r.accessToken,r.refreshToken),r.accessToken}catch(e){throw console.error("Token refresh failed:",e),"invalid_refresh_token"!==e.code&&"refresh_token_expired"!==e.code||(await this.tokenStorage.clearTokens(),this.onSessionExpired()),e}}async checkAndRefreshToken(){try{const e=await this.tokenStorage.getAccessToken();if(!e)return;const t=this._decodeToken(e);if(!t||!t.exp)return;const n=Math.floor(Date.now()/1e3);t.exp-n<this.refreshThreshold&&await this.refreshToken()}catch(e){console.warn("Error checking token expiration:",e)}}_decodeToken(e){try{return(0,o.s)(e)}catch(t){return console.error("Error decoding token:",t),null}}async isAuthenticated(){const e=await this.tokenStorage.getAccessToken();if(!e)return!1;const t=this._decodeToken(e);if(!t||!t.exp)return!1;const n=Math.floor(Date.now()/1e3);return t.exp>n}async getUserInfo(){const e=await this.tokenStorage.getAccessToken();if(!e)return null;const t=this._decodeToken(e);return t?t.user:null}dispose(){clearInterval(this.refreshInterval)}};var g=n(92023),l=n(39929),d=n(92191),u=n(15896),w=n(70579);g.A,g.A,l.A,d.A,d.A,l.A,u.A;const p=(0,r.createContext)(null),k=()=>{const e=(0,r.useContext)(p);if(!e)throw new Error("useAuth doit \xeatre utilis\xe9 \xe0 l'int\xe9rieur d'un AuthProvider");return e}}}]);
//# sourceMappingURL=5918.e5fa85cb.chunk.js.map