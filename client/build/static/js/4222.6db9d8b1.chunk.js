"use strict";(self.webpackChunkgrand_est_cyclisme_client=self.webpackChunkgrand_est_cyclisme_client||[]).push([[4222],{34222:(e,t,i)=>{i.d(t,{A:()=>H});var a=i(65043),s=i(29408),r=i(79183),n=i(71985),o=i(50007),l=i(63336),c=i(96446),d=i(85865),h=i(39948),u=i(42518),m=i(39336),p=i(28267),g=i(60423),f=i(34372),v=i(86213);const y="cache-first",b="stale-while-revalidate",w="network-only",M="cache-only";class x{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.data=e,this.timestamp=Date.now(),this.expiry=this.timestamp+(t.ttl||3e5),this.staleExpiry=this.expiry+(t.staleTime||36e5),this.tags=t.tags||[],this.etag=t.etag||null,this.lastModified=t.lastModified||null}isExpired(){return Date.now()>this.expiry}isStale(){return this.isExpired()&&Date.now()<=this.staleExpiry}extend(e){this.expiry+=e,this.staleExpiry+=e}}const S=new class{constructor(){this.cache=new Map,this.pendingRequests=new Map,this.isInitialized=!1,this.storageKey="api_cache_data",this.defaultTTL=3e5,this.maxCacheSize=100,this.defaultStrategy=y,this.networkMonitor={isOnline:!0,lastCheck:Date.now()},this.statistics={hits:0,misses:0,errors:0,networkCalls:0},this.ttlConfigKey="api_cache_ttl_config",this.categoryTTLs={},this.axiosInstance=v.A.create({timeout:1e4}),this.axiosInstance.interceptors.request.use((e=>{const t=this.generateCacheKey(e.url,e.params),i=this.cache.get(t);return i&&(i.etag&&(e.headers["If-None-Match"]=i.etag),i.lastModified&&(e.headers["If-Modified-Since"]=i.lastModified)),e})),this.axiosInstance.interceptors.response.use((e=>{const t={};return e.headers.etag&&(t.etag=e.headers.etag),e.headers["last-modified"]&&(t.lastModified=e.headers["last-modified"]),e.cacheHeaders=t,e}),(e=>{if(e.response&&304===e.response.status){const t=this.generateCacheKey(e.config.url,e.config.params),i=this.cache.get(t);if(i){const a={data:i.data,status:200,statusText:"OK (from cache)",headers:e.response.headers,config:e.config,fromCache:!0};return i.extend(this.defaultTTL),this.cache.set(t,i),a}}return Promise.reject(e)}))}async initialize(){if(!this.isInitialized)try{await this.loadTTLConfigurations(),f.Ay.isEnabled("enableAdvancedCaching")&&await this.loadCacheFromStorage(),this.setupNetworkMonitoring(),this.setupPeriodicCleanup(),this.isInitialized=!0,console.info("Service de cache API initialis\xe9",{cacheSize:this.cache.size,defaultTTL:this.formatDuration(this.defaultTTL)})}catch(e){console.error("Erreur lors de l'initialisation du cache API:",e)}}setupNetworkMonitoring(){"undefined"!==typeof window&&(window.addEventListener("online",(()=>{this.networkMonitor.isOnline=!0,this.networkMonitor.lastCheck=Date.now(),console.info("Connectivit\xe9 r\xe9tablie - API Cache passe en mode en ligne")})),window.addEventListener("offline",(()=>{this.networkMonitor.isOnline=!1,this.networkMonitor.lastCheck=Date.now(),console.info("Connectivit\xe9 perdue - API Cache passe en mode hors ligne")})),this.networkMonitor.isOnline=navigator.onLine)}setupPeriodicCleanup(){"undefined"!==typeof window&&setInterval((()=>this.cleanupCache()),36e5)}cleanupCache(){if(0===this.cache.size)return;console.info("Nettoyage du cache API en cours...");const e=Date.now();let t=0;for(const[i,a]of this.cache.entries())e>a.staleExpiry&&(this.cache.delete(i),t++);if(this.cache.size>this.maxCacheSize){const e=this.cache.size-this.maxCacheSize,i=Array.from(this.cache.entries()).sort(((e,t)=>e[1].timestamp-t[1].timestamp));for(let a=0;a<e;a++)this.cache.delete(i[a][0]),t++}console.info(`Nettoyage du cache termin\xe9: ${t} entr\xe9es supprim\xe9es`),this.saveCacheToStorage()}async loadCacheFromStorage(){try{const e=localStorage.getItem(this.storageKey);if(!e)return;const t=JSON.parse(e),i=Date.now();let a=0;Object.entries(t).forEach((e=>{let[t,s]=e;const r=new x(s.data,{ttl:s.expiry-s.timestamp,staleTime:s.staleExpiry-s.expiry,tags:s.tags,etag:s.etag,lastModified:s.lastModified});r.timestamp=s.timestamp,r.expiry=s.expiry,r.staleExpiry=s.staleExpiry,i<=r.staleExpiry&&(this.cache.set(t,r),a++)})),console.info(`Cache charg\xe9 depuis le localStorage: ${a} entr\xe9es valides`)}catch(e){console.error("Erreur lors du chargement du cache depuis le localStorage:",e),this.cache.clear()}}saveCacheToStorage(){try{const e={};for(const[t,i]of this.cache.entries())e[t]={data:i.data,timestamp:i.timestamp,expiry:i.expiry,staleExpiry:i.staleExpiry,tags:i.tags,etag:i.etag,lastModified:i.lastModified};localStorage.setItem(this.storageKey,JSON.stringify(e))}catch(e){console.error("Erreur lors de la sauvegarde du cache dans le localStorage:",e)}}generateCacheKey(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const i=e.toLowerCase().trim(),a={};return t&&Object.keys(t).sort().forEach((e=>{a[e]=t[e]})),`${i}|${JSON.stringify(a)}`}async get(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.isInitialized||await this.initialize();const{params:i={},strategy:a=this.defaultStrategy,tags:s=[]}=t,r=this.getTTLForUrl(e,t),n=this.generateCacheKey(e,i),o=this.cache.get(n),l={ttl:r,tags:s};if(!f.Ay.isEnabled("enableApiCaching")||a===w)return this.fetchFromNetwork(e,i);if(a===M){if(o)return this.statistics.hits++,{...o.data,fromCache:!0};throw this.statistics.misses++,new Error("Aucune donn\xe9e en cache et mode CACHE_ONLY activ\xe9")}if(!this.networkMonitor.isOnline){if(o)return console.info("Mode hors ligne - Utilisation du cache pour:",e),{...o.data,fromCache:!0};throw new Error("Aucune donn\xe9e en cache et appareil hors ligne")}if(a===y){if(o&&!o.isExpired())return this.statistics.hits++,{...o.data,fromCache:!0};try{const t=await this.fetchFromNetwork(e,i);return this.cacheResponse(n,t,l),t}catch(c){if(o)return console.warn("Erreur r\xe9seau - Utilisation du cache expir\xe9 pour:",e),{...o.data,fromCache:!0,stale:!0};throw c}}if(a===b){if(o)return o.isExpired()&&this.fetchFromNetworkAndUpdateCache(e,i,n,l).catch((e=>console.error("Erreur lors de la mise \xe0 jour du cache en arri\xe8re-plan:",e))),this.statistics.hits++,{...o.data,fromCache:!0,stale:o.isExpired()};const t=await this.fetchFromNetwork(e,i);return this.cacheResponse(n,t,l),t}try{const t=await this.fetchFromNetwork(e,i);return this.cacheResponse(n,t,l),t}catch(c){if(o)return console.warn("Erreur r\xe9seau - Utilisation du cache pour:",e),this.statistics.hits++,{...o.data,fromCache:!0,stale:o.isExpired()};throw c}}async post(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.axiosInstance.post(e,t,i).then((e=>e.data))}async put(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.axiosInstance.put(e,t,i).then((e=>e.data))}async delete(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.axiosInstance.delete(e,t).then((e=>e.data))}async fetchFromNetworkAndUpdateCache(e,t,i,a){try{const s=await this.fetchFromNetwork(e,t);this.cacheResponse(i,s,a)}catch(s){console.error("Erreur lors de la mise \xe0 jour du cache en arri\xe8re-plan:",s)}}async fetchFromNetwork(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const i=this.generateCacheKey(e,t);if(this.pendingRequests.has(i))return this.pendingRequests.get(i);const a=this.axiosInstance.get(e,{params:t}).then((e=>{const t=e.cacheHeaders||{};return this.statistics.networkCalls++,this.pendingRequests.delete(i),{data:e.data,headers:t,fromCache:!1}})).catch((e=>{throw this.statistics.errors++,this.pendingRequests.delete(i),e}));return this.pendingRequests.set(i,a),a}cacheResponse(e,t){var i,a;let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const{ttl:r=this.defaultTTL,tags:n=[]}=s;if(t.fromCache)return;const o=new x(t.data,{ttl:r,tags:n,etag:null===(i=t.headers)||void 0===i?void 0:i.etag,lastModified:null===(a=t.headers)||void 0===a?void 0:a.lastModified});this.cache.set(e,o),this.cache.size>this.maxCacheSize&&this.pruneCache(),f.Ay.isEnabled("enableAdvancedCaching")&&this.saveCacheToStorage()}pruneCache(){if(this.cache.size<=this.maxCacheSize)return;const e=this.cache.size-this.maxCacheSize,t=Array.from(this.cache.entries()).sort(((e,t)=>e[1].timestamp-t[1].timestamp));for(let i=0;i<e;i++)this.cache.delete(t[i][0])}invalidateCache(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(null===t){const t=e.toLowerCase().trim();for(const e of this.cache.keys())e.startsWith(t)&&this.cache.delete(e)}else{const i=this.generateCacheKey(e,t);this.cache.delete(i)}f.Ay.isEnabled("enableAdvancedCaching")&&this.saveCacheToStorage()}invalidateByTags(e){if(!Array.isArray(e)||0===e.length)return;const t=[];for(const[i,a]of this.cache.entries()){e.some((e=>a.tags.includes(e)))&&t.push(i)}t.forEach((e=>this.cache.delete(e))),t.length>0&&f.Ay.isEnabled("enableAdvancedCaching")&&this.saveCacheToStorage()}clearCache(){this.cache.clear(),localStorage.removeItem(this.storageKey),console.info("Cache API enti\xe8rement effac\xe9")}getStatistics(){return{...this.statistics,cacheSize:this.cache.size,pendingRequests:this.pendingRequests.size}}configure(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e.defaultTTL&&(this.defaultTTL=e.defaultTTL),e.maxCacheSize&&(this.maxCacheSize=e.maxCacheSize),e.defaultStrategy&&(this.defaultStrategy=e.defaultStrategy),console.info("Configuration du cache API mise \xe0 jour:",e)}async loadTTLConfigurations(){try{if(f.Ay.isEnabled("enableConfigurableCacheTTL")){const e=f.Ay.getValue("defaultCacheTTL");e&&"number"===typeof e&&e>0&&(this.defaultTTL=1e3*e,console.info(`TTL de cache global configur\xe9 \xe0 ${this.formatDuration(this.defaultTTL)}`));const t=f.Ay.getValue("categorySpecificTTLs")||{};for(const[i,a]of Object.entries(t))"number"===typeof a&&a>0&&(this.categoryTTLs[i]=1e3*a,console.info(`TTL de cache pour la cat\xe9gorie "${i}" configur\xe9 \xe0 ${this.formatDuration(1e3*a)}`));localStorage.setItem(this.ttlConfigKey,JSON.stringify({defaultTTL:this.defaultTTL,categoryTTLs:this.categoryTTLs}))}else{const t=localStorage.getItem(this.ttlConfigKey);if(t)try{const{defaultTTL:e,categoryTTLs:i}=JSON.parse(t);this.defaultTTL=e||this.defaultTTL,this.categoryTTLs=i||{}}catch(e){console.warn("Impossible de charger la configuration TTL sauvegard\xe9e:",e)}}}catch(t){console.error("Erreur lors du chargement des configurations TTL:",t)}}getTTLForUrl(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(t.ttl&&"number"===typeof t.ttl)return t.ttl;const i=e.toLowerCase(),a={cols:/(\/api\/cols|\/api\/passes)/,user:/\/api\/user/,activities:/\/api\/activities/,routes:/\/api\/routes/,weather:/\/api\/weather/,challenges:/\/api\/challenges/,social:/\/api\/social/};for(const[s,r]of Object.entries(a))if(r.test(i)&&this.categoryTTLs[s])return this.categoryTTLs[s];return this.defaultTTL}formatDuration(e){return e<1e3?`${e}ms`:e<6e4?`${Math.round(e/1e3)}s`:e<36e5?`${Math.round(e/6e4)}m`:`${Math.round(e/36e5)}h`}},E="ultra-low",C="low",L="medium",D="high",T=150,P=300,A=500,I={tree:new s.BoxGeometry(1,2,1),rock:new s.SphereGeometry(1,4,4),building:new s.BoxGeometry(1,1,1)};const R=new class{constructor(){this.progressiveModeEnabled=!0,this.currentDetailLevel=L,this.deviceCapabilities=null,this.loadedModels=new Map,this.loadingProgress={},this.worker=null,this.frustumCullingEnabled=!0,this.lastRenderTime=0,this.targetFrameRate=30,this.renderTimeHistory=[],this.adaptiveQualityEnabled=!0,this.isInitialized=!1,this.texturePool=new Map,this.activeRenderers=new Set,this.memoryMonitorInterval=null,this.contextLossHandled=!1,this.lowMemoryMode=!1,this.deviceMemory=null,this.isIOS=!1,this.estimatedMemoryUsage=0}async initialize(){if(!this.isInitialized)try{if(!f.Ay.isEnabled("enableProgressiveLoading3D"))return console.info("Chargement progressif 3D d\xe9sactiv\xe9 via feature flags"),this.progressiveModeEnabled=!1,void(this.isInitialized=!0);await this.detectDeviceCapabilities(),this.deviceCapabilities.webWorkerSupport&&this.initializeWebWorker(),this.setupContextLossHandlers(),this.deviceCapabilities.isMobile&&this.setupMemoryMonitoring(),console.info("Service de chargement progressif 3D initialis\xe9",{detailLevel:this.currentDetailLevel,adaptiveQuality:this.adaptiveQualityEnabled,webWorker:null!==this.worker,deviceMemory:this.deviceMemory,isMobile:this.deviceCapabilities.isMobile,isIOS:this.isIOS}),this.isInitialized=!0}catch(e){console.error("Erreur lors de l'initialisation du chargement progressif 3D:",e),this.progressiveModeEnabled=!1,this.isInitialized=!0}}async detectDeviceCapabilities(){this.deviceCapabilities={webWorkerSupport:"undefined"!==typeof Worker,webGLVersion:1,maxTextureSize:2048,anisotropySupport:!1,maxAnisotropy:1,isMobile:!1,devicePixelRatio:window.devicePixelRatio||1},this.deviceCapabilities.isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),this.isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,navigator.deviceMemory?this.deviceMemory=navigator.deviceMemory:this.deviceMemory=this.deviceCapabilities.isMobile?2:8;try{const e=document.createElement("canvas");let t=e.getContext("webgl2");if(t?this.deviceCapabilities.webGLVersion=2:(t=e.getContext("webgl")||e.getContext("experimental-webgl"),this.deviceCapabilities.webGLVersion=t?1:0),t){this.deviceCapabilities.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE);const e=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic");e&&(this.deviceCapabilities.anisotropySupport=!0,this.deviceCapabilities.maxAnisotropy=t.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT));const i=t.getExtension("WEBGL_lose_context");i&&i.loseContext()}this.deviceCapabilities.isMobile?(this.deviceMemory<=2?this.currentDetailLevel=C:this.currentDetailLevel=L,this.frustumCullingEnabled=!0):this.deviceCapabilities.webGLVersion>=2?this.currentDetailLevel=D:this.currentDetailLevel=L}catch(e){console.error("Erreur lors de la d\xe9tection des capacit\xe9s WebGL:",e),this.currentDetailLevel=C}return this.deviceCapabilities}unloadModel(e){const t=this.loadedModels.get(e);t&&(t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach((e=>this.disposeMaterial(e))):this.disposeMaterial(t.material)),t.animations&&t.mixer&&(t.mixer.stopAllAction(),t.mixer.uncacheRoot(t)),t.children&&t.children.forEach((e=>{this.disposeObject3D(e)})),t.parent&&t.parent.remove(t),this.loadedModels.delete(e),this.updateMemoryUsage(),console.info(`Mod\xe8le ${e} d\xe9charg\xe9 et ressources lib\xe9r\xe9es`))}disposeMaterial(e){if(e){for(const t in e){const i=e[t];if(i&&i.isTexture)if(this.texturePool.has(i.uuid)){this.texturePool.get(i.uuid).inUse=!1}else i.dispose()}e.dispose()}}disposeObject3D(e){if(e){if(e.children&&e.children.length>0){[...e.children].forEach((t=>{this.disposeObject3D(t),e.remove(t)}))}e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach((e=>this.disposeMaterial(e))):this.disposeMaterial(e.material))}}setupContextLossHandlers(){window.addEventListener("webglcontextlost",(e=>{e.preventDefault(),this.contextLossHandled=!0,console.warn("Contexte WebGL perdu, tentative de r\xe9cup\xe9ration..."),this.activeRenderers.forEach((e=>{e.forceContextLoss()})),this.lowMemoryMode=!0,this.currentDetailLevel=E,document.dispatchEvent(new CustomEvent("webgl-context-lost"))}),!1),window.addEventListener("webglcontextrestored",(()=>{console.info("Contexte WebGL restaur\xe9"),this.contextLossHandled=!1,this.activeRenderers.forEach((e=>{e.resetState()})),this.rebuildTextures(),document.dispatchEvent(new CustomEvent("webgl-context-restored"))}),!1)}setupMemoryMonitoring(){this.memoryMonitorInterval&&clearInterval(this.memoryMonitorInterval),this.memoryMonitorInterval=setInterval((()=>{this.checkMemoryUsage()}),3e4),document.addEventListener("visibilitychange",(()=>{document.hidden?this.releaseNonEssentialResources():this.checkMemoryUsage()}))}checkMemoryUsage(){this.updateMemoryUsage();performance.now();const e=this.estimatedMemoryUsage/1048576;console.debug(`Utilisation estim\xe9e de la m\xe9moire 3D: ${e.toFixed(2)} MB`),e>T?(console.warn(`Utilisation critique de la m\xe9moire: ${e.toFixed(2)} MB`),this.handleCriticalMemory()):e>P?(console.warn(`Avertissement m\xe9moire: ${e.toFixed(2)} MB`),this.decreaseQuality(),this.releaseNonEssentialResources()):e<A&&this.lowMemoryMode&&(this.lowMemoryMode=!1,this.adaptiveQualityEnabled&&this.increaseQuality())}handleCriticalMemory(){this.lowMemoryMode=!0,this.currentDetailLevel=E,this.unloadNonVisibleModels(),this.clearTexturePool(),window.gc&&window.gc(),document.dispatchEvent(new CustomEvent("webgl-memory-critical"))}releaseNonEssentialResources(){this.cleanupTexturePool(),this.unloadNonVisibleModels()}unloadNonVisibleModels(){const e=new Set;document.querySelectorAll('[data-model-visible="true"]').forEach((t=>{const i=t.dataset.modelId;i&&e.add(i)})),this.loadedModels.forEach(((t,i)=>{e.has(i)||this.unloadModel(i)}))}updateMemoryUsage(){let e=0;return this.loadedModels.forEach((t=>{if(t.geometry&&t.geometry.attributes)for(const i in t.geometry.attributes){const a=t.geometry.attributes[i];a.array&&(e+=a.array.byteLength||0)}if(t.material){(Array.isArray(t.material)?t.material:[t.material]).forEach((t=>{for(const i in t){const a=t[i];if(a&&a.isTexture&&a.image){const t=a.image.width||0,i=a.image.height||0;e+=t*i*4}}}))}})),this.texturePool.forEach((t=>{const i=t.texture;if(i&&i.image){const t=i.image.width||0,a=i.image.height||0;e+=t*a*4}})),this.estimatedMemoryUsage=e,e}getTextureFromPool(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};for(const[a,s]of this.texturePool.entries())if(!s.inUse&&s.url===e)return s.inUse=!0,s.texture;const i=(new s.TextureLoader).load(e);return t.anisotropy&&this.deviceCapabilities.anisotropySupport&&(i.anisotropy=Math.min(t.anisotropy,this.deviceCapabilities.maxAnisotropy)),this.texturePool.set(i.uuid,{texture:i,url:e,inUse:!0,lastUsed:Date.now()}),i}cleanupTexturePool(){const e=Date.now();for(const[t,i]of this.texturePool.entries())!i.inUse&&e-i.lastUsed>6e4&&(i.texture.dispose(),this.texturePool.delete(t))}clearTexturePool(){for(const[e,t]of this.texturePool.entries())t.texture.dispose();this.texturePool.clear()}rebuildTextures(){const e=new Map;this.texturePool.forEach(((t,i)=>{t.inUse&&e.set(i,{url:t.url,options:t.options})})),this.clearTexturePool(),e.forEach(((e,t)=>{const i=this.getTextureFromPool(e.url,e.options);this.loadedModels.forEach((e=>{if(e.material){(Array.isArray(e.material)?e.material:[e.material]).forEach((e=>{for(const a in e)e[a]&&e[a].isTexture&&e[a].uuid===t&&(e[a]=i)}))}}))}))}registerRenderer(e){e&&!this.activeRenderers.has(e)&&(this.activeRenderers.add(e),this.deviceCapabilities.isMobile&&(e.setPixelRatio(Math.min(this.deviceCapabilities.devicePixelRatio,2)),e.shadowMap.enabled=this.currentDetailLevel!==E&&this.currentDetailLevel!==C,e.shadowMap.autoUpdate=!1))}unregisterRenderer(e){e&&this.activeRenderers.has(e)&&this.activeRenderers.delete(e)}optimizeGeometryForMobile(e){if(!e||!this.deviceCapabilities.isMobile)return e;const t=e.clone();return this.currentDetailLevel!==E&&this.currentDetailLevel!==C||!g.ec?t:(0,g.ec)(t,.01)}dispose(){this.worker&&(this.worker.terminate(),this.worker=null),this.memoryMonitorInterval&&(clearInterval(this.memoryMonitorInterval),this.memoryMonitorInterval=null),this.loadedModels.forEach(((e,t)=>{this.unloadModel(t)}));for(const e in I)I[e]&&I[e].dispose();this.clearTexturePool(),this.activeRenderers.clear(),this.loadedModels.clear(),this.loadingProgress={},this.renderTimeHistory=[],this.isInitialized=!1,this.contextLossHandled=!1,this.lowMemoryMode=!1,window.gc&&window.gc(),console.info("Service de chargement progressif 3D lib\xe9r\xe9 et ressources WebGL nettoy\xe9es")}},O={api:{standard:1e4,long:3e4,download:6e4,upload:12e4},ui:{toast:3e3,autoClose:5e3,animation:300,debounce:300,throttle:100},features:{nutrition:{calculation:8e3,synchronization:15e3},training:{planGeneration:2e4,routeCalculation:3e4},visualization3D:{load:25e3,render:5e3},weatherData:{forecast:12e3,historical:2e4}},retry:{maxAttempts:3,baseDelay:1e3,maxDelay:15e3,factor:2}};new class{constructor(){this.config={...O},this.activeTimeouts=new Map,this.activeIntervals=new Map,this.pendingOperations=new Map,this.isInitialized=!1}initialize(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!this.isInitialized)try{const i=localStorage.getItem("timeout_config");if(i)try{const e=JSON.parse(i);this.config=this.mergeConfigs(this.config,e)}catch(t){console.error("Erreur lors du parsing de la configuration des timeouts:",t)}e&&Object.keys(e).length>0&&(this.config=this.mergeConfigs(this.config,e)),this.isInitialized=!0,console.info("Service de configuration des timeouts initialis\xe9")}catch(t){console.error("Erreur lors de l'initialisation du service de timeouts:",t),this.config={...O},this.isInitialized=!0}}mergeConfigs(e,t){const i={...e};for(const[a,s]of Object.entries(t))"object"!==typeof s||null===s||Array.isArray(s)||"object"!==typeof e[a]?i[a]=s:i[a]=this.mergeConfigs(e[a],s);return i}getTimeout(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e4;this.isInitialized||this.initialize();const i=e.split(".");let a=this.config;for(const s of i){if(!a||"object"!==typeof a||!(s in a))return t;a=a[s]}return"number"===typeof a?a:t}setTimeout(e,t){let i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(this.isInitialized||this.initialize(),"number"!==typeof t||t<0)return void console.error("Valeur de timeout invalide:",t);const a=e.split(".");let s=this.config;for(let r=0;r<a.length-1;r++){const e=a[r];e in s||(s[e]={}),s=s[e]}s[a[a.length-1]]=t,i&&localStorage.setItem("timeout_config",JSON.stringify(this.config))}setTimeout(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this.isInitialized||this.initialize();const a=i||`timeout_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,s=setTimeout((()=>{this.activeTimeouts.delete(a),e()}),t);return this.activeTimeouts.set(a,{handle:s,created:Date.now(),delay:t,expires:Date.now()+t}),a}setInterval(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this.isInitialized||this.initialize();const a=i||`interval_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,s=setInterval(e,t);return this.activeIntervals.set(a,{handle:s,created:Date.now(),delay:t}),a}clearTimeout(e){if(this.activeTimeouts.has(e)){const{handle:t}=this.activeTimeouts.get(e);return clearTimeout(t),this.activeTimeouts.delete(e),!0}return!1}clearInterval(e){if(this.activeIntervals.has(e)){const{handle:t}=this.activeIntervals.get(e);return clearInterval(t),this.activeIntervals.delete(e),!0}return!1}async withTimeout(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.isInitialized||this.initialize();const{defaultTimeout:a=1e4,onTimeout:s=null,id:r=null,abortable:n=!1}=i,o=this.getTimeout(t,a),l=r||`operation_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,c=n?new AbortController:null,d=c?c.signal:null;return this.pendingOperations.set(l,{id:l,started:Date.now(),timeout:o,controller:c,timeoutPath:t}),new Promise(((t,i)=>{const a=this.setTimeout((()=>{this.pendingOperations.delete(l),c&&c.abort(),s&&s(l,o),i(new Error(`Op\xe9ration ${l} expir\xe9e apr\xe8s ${o}ms`))}),o,`timeout_for_${l}`);Promise.resolve().then((()=>e(d))).then((e=>{this.clearTimeout(a),this.pendingOperations.delete(l),t(e)})).catch((e=>{this.clearTimeout(a),this.pendingOperations.delete(l),i(e)}))}))}async withRetry(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.isInitialized||this.initialize();const{maxAttempts:i=this.config.retry.maxAttempts,baseDelay:a=this.config.retry.baseDelay,maxDelay:s=this.config.retry.maxDelay,factor:r=this.config.retry.factor,shouldRetry:n=null,onRetry:o=null,timeoutPath:l=null}=t;let c=0;const d=async()=>{try{return c++,l?await this.withTimeout(e,l):await e()}catch(t){if(!(c<i&&(!n||n(t,c))))throw t;const e=Math.min(a*Math.pow(r,c-1),s);return o&&o(t,c,e),await new Promise((t=>setTimeout(t,e))),d()}};return d()}async withParallelTimeout(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.isInitialized||this.initialize();const{defaultTimeout:a=3e4,allOrNothing:s=!1,onTimeout:r=null}=i,n=this.getTimeout(t,a),o=`parallel_${Date.now()}_${Math.random().toString(36).substring(2,9)}`;return new Promise(((t,i)=>{const a=this.setTimeout((()=>{r&&r(o,n),s?i(new Error(`Op\xe9rations parall\xe8les expir\xe9es apr\xe8s ${n}ms`)):t(l.map(((e,t)=>e._settled?e._result:new Error(`Op\xe9ration ${t} expir\xe9e`))))}),n,`timeout_for_${o}`),l=e.map(((e,t)=>{const i=Promise.resolve().then((()=>e()));return i._settled=!1,i._result=null,i.then((e=>(i._settled=!0,i._result=e,e))).catch((e=>{throw i._settled=!0,i._result=e,e}))}));Promise.all(l).then((e=>{this.clearTimeout(a),t(e)})).catch((e=>{s?(this.clearTimeout(a),i(e)):Promise.allSettled(l).then((()=>{this.clearTimeout(a),t(l.map((e=>e._result)))}))}))}))}debounce(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.isInitialized||this.initialize();const{timeoutPath:a="ui.debounce",leading:s=!1,trailing:r=!0,maxWait:n=null}=i,o=t||this.getTimeout(a,300);let l=null,c=null,d=null,h=0,u=0;function m(){const t=c,i=d;return c=d=null,u=Date.now(),e.apply(i,t)}function p(){return l=null,r&&c?m():(c=d=null,null)}function g(){const e=Date.now(),t=function(){const e=Date.now();return 0===h||e-h>=o||null!==n&&e-u>=n}();for(var i=arguments.length,a=new Array(i),r=0;r<i;r++)a[r]=arguments[r];if(c=a,d=this,h=e,t){if(null===l)return u=Date.now(),l=setTimeout(p,o),s?m():null;if(null!==n)return l=setTimeout(p,o),m()}return null===l&&(l=setTimeout(p,o)),null}return g.cancel=function(){null!==l&&(clearTimeout(l),l=null),c=d=null,h=u=0},g.flush=function(){return null===l?null:p()},g}throttle(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.isInitialized||this.initialize();const{timeoutPath:a="ui.throttle",leading:s=!0,trailing:r=!0}=i,n=t||this.getTimeout(a,100);return this.debounce(e,n,{leading:s,trailing:r,maxWait:n})}dispose(){for(const[e,{handle:t}]of this.activeTimeouts.entries())clearTimeout(t);for(const[e,{handle:t}]of this.activeIntervals.entries())clearInterval(t);this.activeTimeouts.clear(),this.activeIntervals.clear(),this.pendingOperations.clear(),console.info("Service de timeout lib\xe9r\xe9")}};const k={ULTRA_LOW:0,LOW:1,MEDIUM_LOW:2,MEDIUM:3,MEDIUM_HIGH:4,HIGH:5,ULTRA_HIGH:6};new class{constructor(){this.PERF_LEVELS=k,this.QUALITY_PRESETS={ULTRA_LOW:{terrainSegments:32,terrainTexture:512,usePostProcessing:!1,useRealisticLighting:!1,useShadows:!1,drawDistance:5e3,useAntialiasing:!1,useBloom:!1,particleDensity:.2,maxPointsOfInterest:5,maxBackgroundModels:0},LOW:{terrainSegments:64,terrainTexture:1024,usePostProcessing:!1,useRealisticLighting:!1,useShadows:!1,drawDistance:8e3,useAntialiasing:!1,useBloom:!1,particleDensity:.4,maxPointsOfInterest:10,maxBackgroundModels:2},MEDIUM_LOW:{terrainSegments:96,terrainTexture:1024,usePostProcessing:!1,useRealisticLighting:!0,useShadows:!1,drawDistance:1e4,useAntialiasing:!0,useBloom:!1,particleDensity:.6,maxPointsOfInterest:15,maxBackgroundModels:5},MEDIUM:{terrainSegments:128,terrainTexture:2048,usePostProcessing:!0,useRealisticLighting:!0,useShadows:!0,drawDistance:12e3,useAntialiasing:!0,useBloom:!1,particleDensity:.7,maxPointsOfInterest:20,maxBackgroundModels:8},MEDIUM_HIGH:{terrainSegments:160,terrainTexture:2048,usePostProcessing:!0,useRealisticLighting:!0,useShadows:!0,drawDistance:15e3,useAntialiasing:!0,useBloom:!0,particleDensity:.8,maxPointsOfInterest:30,maxBackgroundModels:12},HIGH:{terrainSegments:192,terrainTexture:4096,usePostProcessing:!0,useRealisticLighting:!0,useShadows:!0,drawDistance:2e4,useAntialiasing:!0,useBloom:!0,particleDensity:.9,maxPointsOfInterest:50,maxBackgroundModels:20},ULTRA_HIGH:{terrainSegments:256,terrainTexture:4096,usePostProcessing:!0,useRealisticLighting:!0,useShadows:!0,drawDistance:3e4,useAntialiasing:!0,useBloom:!0,particleDensity:1,maxPointsOfInterest:100,maxBackgroundModels:30}},this.perfLevel=null,this.isDetecting=!1,this.onDetectionComplete=null,this.detectionTimeout=1e4,this.testDuration=3e3,this.targetFPS=60,this.minimumAcceptableFPS=30,this.userOverrides={},this.storageKey="gec_performance_settings",this.defaultLevel=k.MEDIUM}async detectPerformance(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(this.isDetecting)return void console.log("D\xe9tection de performance d\xe9j\xe0 en cours");this.isDetecting=!0,this.onDetectionComplete=e;const t=new Promise((async e=>{console.log("D\xe9marrage de la d\xe9tection de performance...");const t=this._loadUserSettings();if(t&&void 0!==t.userSelectedLevel)return console.log("Utilisation des r\xe9glages utilisateur sauvegard\xe9s"),this.perfLevel=t.userSelectedLevel,this.isDetecting=!1,this.onDetectionComplete&&this.onDetectionComplete(this.perfLevel),void e({level:this.perfLevel,preset:this._getQualityPreset(),source:"user_preference"});try{const t=this._detectInitialLevel(),i=await this._runFPSTest();this.perfLevel=this._determineLevelFromFPS(i,t),this.perfLevel=this._adjustForMemoryAndResolution(this.perfLevel),console.log(`D\xe9tection termin\xe9e: niveau de performance ${this.perfLevel}`),this._saveDetectionResult(),this.onDetectionComplete&&this.onDetectionComplete(this.perfLevel),this.isDetecting=!1,e({level:this.perfLevel,preset:this._getQualityPreset(),source:"detection",fps:i})}catch(i){console.error("Erreur lors de la d\xe9tection de performance:",i),this.perfLevel=k.MEDIUM_LOW,this.isDetecting=!1,this.onDetectionComplete&&this.onDetectionComplete(this.perfLevel),e({level:this.perfLevel,preset:this._getQualityPreset(),source:"error_fallback",error:i.message})}})),i=new Promise((e=>{setTimeout((()=>{this.isDetecting&&(console.warn("Timeout de d\xe9tection de performance"),this.isDetecting=!1,this.perfLevel=this.defaultLevel,this.onDetectionComplete&&this.onDetectionComplete(this.perfLevel),e({level:this.perfLevel,preset:this._getQualityPreset(),source:"timeout"}))}),this.detectionTimeout)}));return Promise.race([t,i])}getQualitySettings(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(null===this.perfLevel&&null===e)return console.warn("Niveau de performance non d\xe9tect\xe9, utilisation du niveau par d\xe9faut"),this._getLevelPreset(this.defaultLevel);const t=null!==e?e:this.perfLevel;return{...this._getLevelPreset(t),...this.userOverrides}}setQualityLevel(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return Object.values(k).includes(e)?(this.perfLevel=e,t&&this._saveUserSettings({userSelectedLevel:e}),this.getQualitySettings()):(console.error("Niveau de qualit\xe9 invalide"),this.getQualitySettings())}overrideSettings(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return this.userOverrides={...this.userOverrides,...e},t&&this._saveUserSettings({overrides:this.userOverrides}),this.getQualitySettings()}resetToDetectedSettings(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return this.userOverrides={},e&&localStorage.removeItem(this.storageKey),null===this.perfLevel?(this.detectPerformance(),this._getLevelPreset(this.defaultLevel)):this.getQualitySettings()}async progressiveLoad(e,t){null===this.perfLevel&&await this.detectPerformance();const i=this._getLevelPreset(k.LOW);try{await e(i);const a=this.getQualitySettings();if(this.perfLevel>k.LOW){const e=this.perfLevel-k.LOW;for(let i=1;i<=e;i++){const a=k.LOW+i,s=this._getLevelPreset(a);await new Promise((e=>setTimeout(e,300))),await t(s,i,e)}}return{success:!0,finalSettings:a}}catch(a){return console.error("Erreur lors du chargement progressif:",a),{success:!1,error:a.message,finalSettings:i}}}_detectInitialLevel(){const e=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),t=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);let i=3;navigator.deviceMemory&&(i=Math.min(6,Math.max(1,Math.floor(navigator.deviceMemory))));let a=3;navigator.hardwareConcurrency&&(a=Math.min(6,Math.max(1,Math.floor(navigator.hardwareConcurrency/2))));const s=window.screen.width*window.screen.height,r=Math.min(6,Math.max(1,Math.floor(s/921600)));let n=Math.round((i+a+r)/3);return e&&(n=Math.min(n,4)),t&&(n=Math.min(n,3)),console.log(`D\xe9tection initiale: mobile=${e}, safari=${t}, m\xe9moire=${i}, CPU=${a}, r\xe9solution=${r}, score=${n}`),n}async _runFPSTest(){return new Promise((e=>{const t=document.createElement("canvas");t.width=512,t.height=512,t.style.position="absolute",t.style.left="-9999px",document.body.appendChild(t);const i=t.getContext("webgl")||t.getContext("experimental-webgl");if(!i)return document.body.removeChild(t),void e({avgFps:15,framesCount:0,supported:!1});let a=performance.now(),s=0,r=0;const n=()=>{i.clearColor(0,0,0,1),i.clear(i.COLOR_BUFFER_BIT);const l=performance.now();if(s++,r+=1e3/(l-a),a=l,performance.now()-o<this.testDuration)requestAnimationFrame(n);else{document.body.removeChild(t);const i=r/s;console.log(`Test FPS termin\xe9: ${i.toFixed(2)} FPS moyen sur ${s} frames`),e({avgFps:i,framesCount:s,duration:this.testDuration,supported:!0})}},o=performance.now();requestAnimationFrame(n)}))}_determineLevelFromFPS(e,t){if(!e.supported)return k.ULTRA_LOW;const{avgFps:i}=e;return i<20?k.ULTRA_LOW:i<30?k.LOW:i<40?k.MEDIUM_LOW:i<50?k.MEDIUM:i<55?k.MEDIUM_HIGH:i<59?k.HIGH:i>=59&&t>=k.HIGH?k.ULTRA_HIGH:k.HIGH}_adjustForMemoryAndResolution(e){navigator.deviceMemory&&(navigator.deviceMemory<=2&&e>k.MEDIUM&&(e=k.MEDIUM),navigator.deviceMemory<=1&&e>k.LOW&&(e=k.LOW));const t=window.screen.width*window.screen.height;return t>3686400&&e<k.MEDIUM_HIGH&&(e=k.MEDIUM_HIGH),t>8294400&&navigator.deviceMemory&&navigator.deviceMemory<=4&&(e=Math.min(e,k.MEDIUM_HIGH)),e}_getLevelPreset(e){switch(e){case k.ULTRA_LOW:return this.QUALITY_PRESETS.ULTRA_LOW;case k.LOW:return this.QUALITY_PRESETS.LOW;case k.MEDIUM_LOW:return this.QUALITY_PRESETS.MEDIUM_LOW;case k.MEDIUM:return this.QUALITY_PRESETS.MEDIUM;case k.MEDIUM_HIGH:return this.QUALITY_PRESETS.MEDIUM_HIGH;case k.HIGH:return this.QUALITY_PRESETS.HIGH;case k.ULTRA_HIGH:return this.QUALITY_PRESETS.ULTRA_HIGH;default:return this.QUALITY_PRESETS.MEDIUM}}_getQualityPreset(){return this._getLevelPreset(this.perfLevel||this.defaultLevel)}_saveDetectionResult(){localStorage.setItem(this.storageKey,JSON.stringify({detectedLevel:this.perfLevel,timestamp:Date.now(),userAgent:navigator.userAgent}))}_saveUserSettings(e){const t=this._loadUserSettings()||{};localStorage.setItem(this.storageKey,JSON.stringify({...t,...e,timestamp:Date.now()}))}_loadUserSettings(){try{const e=localStorage.getItem(this.storageKey);return e?JSON.parse(e):null}catch(e){return console.error("Erreur lors du chargement des pr\xe9f\xe9rences:",e),null}}};const z=new class{constructor(){this.capabilities={gpu:{webGLSupport:!1,webGL2Support:!1,renderer:null,vendor:null,estimatedMemory:0,maxTextureSize:0,maxCubemapSize:0,glExtensions:[],isMobileGPU:!1},cpu:{cores:navigator.hardwareConcurrency||2,estimatedPerformance:"medium"},screen:{resolution:{width:window.screen.width,height:window.screen.height},pixelRatio:window.devicePixelRatio||1,effectiveResolution:{width:Math.round(window.screen.width*(window.devicePixelRatio||1)),height:Math.round(window.screen.height*(window.devicePixelRatio||1))},isHighDensity:(window.devicePixelRatio||1)>1.5},network:{type:"unknown",effectiveType:"unknown",downlink:0,rtt:0,saveData:!1},flags:{isMobile:!1,isTablet:!1,isLowEndDevice:!1,hasBatteryConstraints:!1,preferReducedMotion:!1,isOffline:!navigator.onLine},performanceLevel:k.MEDIUM},this.benchmarkResults=null,this.detectionComplete=!1,this.detect()}getCapabilities(){return this.detectionComplete||console.warn("DeviceCapabilityDetector: getCapabilities appel\xe9 avant la fin de la d\xe9tection"),this.capabilities}async detect(){try{await Promise.all([this.detectGPUCapabilities(),this.detectNetworkConditions(),this.detectAccessibilityPreferences(),this.detectDeviceType(),this.detectBatteryStatus()]),this.loadCachedResults();(!this.benchmarkResults||Date.now()-this.benchmarkResults.timestamp>864e5)&&(this.benchmarkResults=await this.runLightBenchmark(),this.cacheBenchmarkResults()),this.finalizeDetection(),this.detectionComplete=!0,console.log("DeviceCapabilityDetector: d\xe9tection termin\xe9e",{performanceLevel:this.getPerformanceLevelName(this.capabilities.performanceLevel),isMobile:this.capabilities.flags.isMobile,gpuMemory:this.capabilities.gpu.estimatedMemory+"MB",cores:this.capabilities.cpu.cores})}catch(e){console.error("DeviceCapabilityDetector: erreur lors de la d\xe9tection",e),this.applyDefaultValues(),this.detectionComplete=!0}return this.capabilities}async detectGPUCapabilities(){try{if(this.capabilities.gpu.webGLSupport=this.isWebGLSupported(),this.capabilities.gpu.webGL2Support=this.isWebGL2Supported(),!this.capabilities.gpu.webGLSupport)return void console.warn("DeviceCapabilityDetector: WebGL non support\xe9");const e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl");if(!t)return;const i=t.getExtension("WEBGL_debug_renderer_info");i&&(this.capabilities.gpu.renderer=t.getParameter(i.UNMASKED_RENDERER_WEBGL),this.capabilities.gpu.vendor=t.getParameter(i.UNMASKED_VENDOR_WEBGL));const a=this.estimateGPUMemory(t,this.capabilities.gpu.renderer);this.capabilities.gpu.estimatedMemory=a,this.capabilities.gpu.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.capabilities.gpu.maxCubemapSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this.capabilities.gpu.glExtensions=t.getSupportedExtensions(),this.capabilities.gpu.isMobileGPU=this.isMobileGPU(this.capabilities.gpu.renderer)}catch(e){console.error("DeviceCapabilityDetector: erreur lors de la d\xe9tection GPU",e)}}async detectNetworkConditions(){try{const e=navigator.connection||navigator.mozConnection||navigator.webkitConnection;e&&(this.capabilities.network.type=e.type||"unknown",this.capabilities.network.effectiveType=e.effectiveType||"unknown",this.capabilities.network.downlink=e.downlink||0,this.capabilities.network.rtt=e.rtt||0,this.capabilities.network.saveData=!!e.saveData,e.addEventListener("change",(()=>{this.capabilities.network.type=e.type||"unknown",this.capabilities.network.effectiveType=e.effectiveType||"unknown",this.capabilities.network.downlink=e.downlink||0,this.capabilities.network.rtt=e.rtt||0,this.capabilities.network.saveData=!!e.saveData})))}catch(e){console.error("DeviceCapabilityDetector: erreur lors de la d\xe9tection r\xe9seau",e)}}async detectAccessibilityPreferences(){try{if(window.matchMedia){const e=window.matchMedia("(prefers-reduced-motion: reduce)");this.capabilities.flags.preferReducedMotion=e.matches,e.addEventListener("change",(e=>{this.capabilities.flags.preferReducedMotion=e.matches}))}}catch(e){console.error("DeviceCapabilityDetector: erreur lors de la d\xe9tection des pr\xe9f\xe9rences",e)}}async detectDeviceType(){try{const e=navigator.userAgent||navigator.vendor||window.opera||"",t=/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i,i=/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(ad|hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i;if(this.capabilities.flags.isMobile=t.test(e),this.capabilities.flags.isTablet=i.test(e)&&!t.test(e),!this.capabilities.flags.isTablet&&!this.capabilities.flags.isMobile){const e=600,t=1024,i=window.screen.width;i>=e&&i<=t&&(this.capabilities.flags.isTablet=!0)}this.capabilities.flags.isLowEndDevice=this.isLowEndDevice()}catch(e){console.error("DeviceCapabilityDetector: erreur lors de la d\xe9tection du type d'appareil",e)}}async detectBatteryStatus(){try{if(navigator.getBattery){const e=await navigator.getBattery();this.capabilities.flags.hasBatteryConstraints=!e.charging&&e.level<.3,e.addEventListener("levelchange",(()=>{this.capabilities.flags.hasBatteryConstraints=!e.charging&&e.level<.3})),e.addEventListener("chargingchange",(()=>{this.capabilities.flags.hasBatteryConstraints=!e.charging&&e.level<.3}))}}catch(e){console.error("DeviceCapabilityDetector: erreur lors de la d\xe9tection de la batterie",e)}}loadCachedResults(){try{const e=localStorage.getItem("deviceBenchmarkResults");e&&(this.benchmarkResults=JSON.parse(e))}catch(e){console.error("DeviceCapabilityDetector: erreur lors du chargement des r\xe9sultats",e)}}async runLightBenchmark(){console.log("DeviceCapabilityDetector: d\xe9marrage du benchmark l\xe9ger");const e={timestamp:Date.now(),scores:{}};try{const t=performance.now();let i=0;for(let e=0;e<1e6;e++)i+=Math.sqrt(e)*Math.sin(e);const a=performance.now();e.scores.cpu=1e3/(a-t);const s=performance.now(),r=document.createElement("div");document.body.appendChild(r);for(let e=0;e<1e3;e++){const t=document.createElement("div");t.textContent="test",t.style.backgroundColor=e%2===0?"red":"blue",r.appendChild(t)}r.scrollTop=100,document.body.removeChild(r);const n=performance.now();e.scores.dom=1e3/(n-s),this.capabilities.gpu.webGLSupport?e.scores.gpu=await this.runWebGLBenchmark():e.scores.gpu=0,e.scores.overall=.3*e.scores.cpu+.3*e.scores.dom+.4*e.scores.gpu,console.log("DeviceCapabilityDetector: benchmark termin\xe9",e.scores)}catch(t){console.error("DeviceCapabilityDetector: erreur lors du benchmark",t),e.scores={cpu:5,dom:5,gpu:5,overall:5}}return e}async runWebGLBenchmark(){return new Promise((e=>{try{const t=document.createElement("canvas");t.width=512,t.height=512;const i=t.getContext("webgl");if(!i)return void e(0);const a=i.createShader(i.VERTEX_SHADER);i.shaderSource(a,"\n          attribute vec2 position;\n          void main() {\n            gl_Position = vec4(position, 0.0, 1.0);\n          }\n        "),i.compileShader(a);const s=i.createShader(i.FRAGMENT_SHADER);i.shaderSource(s,"\n          precision mediump float;\n          uniform float time;\n          \n          void main() {\n            vec2 uv = gl_FragCoord.xy / 512.0;\n            float x = uv.x * sin(time * 0.1) * 10.0;\n            float y = uv.y * cos(time * 0.1) * 10.0;\n            \n            for(int i = 0; i < 10; i++) {\n              x = sin(x * y + time * 0.1) * 0.5 + 0.5;\n              y = cos(x * y + time * 0.1) * 0.5 + 0.5;\n            }\n            \n            gl_FragColor = vec4(x, y, x * y, 1.0);\n          }\n        "),i.compileShader(s);const r=i.createProgram();i.attachShader(r,a),i.attachShader(r,s),i.linkProgram(r),i.useProgram(r);const n=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,n),i.bufferData(i.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1]),i.STATIC_DRAW);const o=i.getAttribLocation(r,"position");i.enableVertexAttribArray(o),i.vertexAttribPointer(o,2,i.FLOAT,!1,0,0);const l=i.getUniformLocation(r,"time");let c=0;const d=performance.now(),h=1e3,u=()=>{i.uniform1f(l,.001*performance.now()),i.drawArrays(i.TRIANGLE_STRIP,0,4),c++;const t=performance.now()-d;if(t<h)requestAnimationFrame(u);else{const i=c/(.001*t),a=Math.min(i/30,10);e(a)}};u()}catch(t){console.error("DeviceCapabilityDetector: erreur dans le benchmark WebGL",t),e(0)}}))}cacheBenchmarkResults(){try{this.benchmarkResults&&localStorage.setItem("deviceBenchmarkResults",JSON.stringify(this.benchmarkResults))}catch(e){console.error("DeviceCapabilityDetector: erreur lors de la mise en cache",e)}}finalizeDetection(){try{var e,t;let i=k.MEDIUM;this.capabilities.flags.isLowEndDevice||this.capabilities.gpu.estimatedMemory<512||(null===(e=this.benchmarkResults)||void 0===e?void 0:e.scores.overall)<3?i=k.LOW:this.capabilities.gpu.estimatedMemory>=2048&&!this.capabilities.flags.isMobile&&this.capabilities.cpu.cores>=4&&(null===(t=this.benchmarkResults)||void 0===t?void 0:t.scores.overall)>7&&(i=k.HIGH),"2g"===this.capabilities.network.effectiveType||"slow-2g"===this.capabilities.network.effectiveType?i=Math.max(k.ULTRA_LOW,i-2):"3g"===this.capabilities.network.effectiveType&&(i=Math.max(k.LOW,i-1)),this.capabilities.flags.preferReducedMotion&&(i=Math.min(i,k.MEDIUM)),this.capabilities.flags.hasBatteryConstraints&&(i=Math.max(k.LOW,i-1)),this.capabilities.performanceLevel=i}catch(i){console.error("DeviceCapabilityDetector: erreur lors de la finalisation",i),this.capabilities.performanceLevel=k.MEDIUM}}applyDefaultValues(){this.capabilities.gpu.estimatedMemory=512,this.capabilities.flags.isLowEndDevice=!0,this.capabilities.performanceLevel=k.MEDIUM}isWebGLSupported(){try{const e=document.createElement("canvas");return!(!window.WebGLRenderingContext||!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}catch(e){return!1}}isWebGL2Supported(){try{const e=document.createElement("canvas");return!(!window.WebGL2RenderingContext||!e.getContext("webgl2"))}catch(e){return!1}}estimateGPUMemory(e,t){if(t){const e=t.toLowerCase();if(e.includes("adreno"))return e.includes("adreno 6")?2048:e.includes("adreno 5")?1024:512;if(e.includes("mali"))return e.includes("mali-g")?2048:1024;if(e.includes("apple"))return e.includes("a14")||e.includes("a15")?4096:e.includes("a12")||e.includes("a13")?3072:e.includes("a10")||e.includes("a11")?2048:1536;if(e.includes("nvidia")||e.includes("geforce"))return e.includes("rtx")?8192:e.includes("gtx 16")||e.includes("gtx 10")?6144:4096;if(e.includes("amd")||e.includes("radeon"))return e.includes("rx 6")?8192:e.includes("rx 5")?6144:4096;if(e.includes("intel"))return e.includes("iris")?2048:e.includes("uhd")?1536:1024}const i=e.getParameter(e.MAX_TEXTURE_SIZE);return i>=16384?4096:i>=8192?2048:i>=4096?1024:512}isMobileGPU(e){if(!e)return!1;const t=e.toLowerCase();return t.includes("adreno")||t.includes("mali")||t.includes("sgx")||t.includes("apple")&&(t.includes("iphone")||t.includes("ipad"))}isLowEndDevice(){return"deviceMemory"in navigator&&navigator.deviceMemory<2||(!!(navigator.hardwareConcurrency&&navigator.hardwareConcurrency<4)||this.capabilities.gpu.estimatedMemory<512)}getPerformanceLevelName(e){switch(e){case k.ULTRA_LOW:return"Ultra faible";case k.LOW:return"Faible";case k.MEDIUM:return"Moyen";case k.HIGH:return"\xc9lev\xe9";case k.ULTRA_HIGH:return"Ultra \xe9lev\xe9";default:return"Moyen"}}};const _=new class{constructor(){this.configs={colVisualization:{[k.ULTRA_LOW]:{terrainSegments:32,textureSize:256,drawDistance:2500,textureQuality:"very-low",shadowsEnabled:!1,postProcessingEnabled:!1,ambientOcclusionEnabled:!1,reflectionsEnabled:!1,maxPointsOfInterest:5,occlusionCullingEnabled:!0,modelDetailLevel:"very-low",interactiveObjects:"minimal",useSimplifiedGeometry:!0,maxParticles:0,fogEnabled:!1,animationLevel:"none",backgroundDetail:"none",lightingComplexity:"basic",maxFrameRate:30},[k.LOW]:{terrainSegments:64,textureSize:512,drawDistance:5e3,textureQuality:"low",shadowsEnabled:!1,postProcessingEnabled:!1,ambientOcclusionEnabled:!1,reflectionsEnabled:!1,maxPointsOfInterest:10,occlusionCullingEnabled:!0,modelDetailLevel:"low",interactiveObjects:"reduced",useSimplifiedGeometry:!0,maxParticles:100,fogEnabled:!0,animationLevel:"minimal",backgroundDetail:"low",lightingComplexity:"basic",maxFrameRate:45},[k.MEDIUM]:{terrainSegments:128,textureSize:1024,drawDistance:1e4,textureQuality:"medium",shadowsEnabled:!0,shadowMapSize:1024,postProcessingEnabled:!1,ambientOcclusionEnabled:!1,reflectionsEnabled:!1,maxPointsOfInterest:25,occlusionCullingEnabled:!0,modelDetailLevel:"medium",interactiveObjects:"standard",useSimplifiedGeometry:!1,maxParticles:500,fogEnabled:!0,animationLevel:"reduced",backgroundDetail:"medium",lightingComplexity:"standard",maxFrameRate:60},[k.HIGH]:{terrainSegments:256,textureSize:2048,drawDistance:15e3,textureQuality:"high",shadowsEnabled:!0,shadowMapSize:2048,postProcessingEnabled:!0,postProcessingEffects:["bloom","fxaa"],ambientOcclusionEnabled:!0,reflectionsEnabled:!1,maxPointsOfInterest:40,occlusionCullingEnabled:!0,modelDetailLevel:"high",interactiveObjects:"all",useSimplifiedGeometry:!1,maxParticles:1e3,fogEnabled:!0,animationLevel:"full",backgroundDetail:"high",lightingComplexity:"advanced",maxFrameRate:90},[k.ULTRA_HIGH]:{terrainSegments:512,textureSize:4096,drawDistance:25e3,textureQuality:"ultra",shadowsEnabled:!0,shadowMapSize:4096,postProcessingEnabled:!0,postProcessingEffects:["bloom","ssao","godrays","fxaa"],ambientOcclusionEnabled:!0,reflectionsEnabled:!0,maxPointsOfInterest:60,occlusionCullingEnabled:!1,modelDetailLevel:"ultra",interactiveObjects:"all",useSimplifiedGeometry:!1,maxParticles:5e3,fogEnabled:!0,animationLevel:"full",backgroundDetail:"ultra",lightingComplexity:"physically-based",maxFrameRate:144}},trainingVisualization:{[k.ULTRA_LOW]:{avatarSegments:8,environmentDetail:"very-low",maxCyclists:2,textureQuality:"very-low",shadowsEnabled:!1,effectsEnabled:!1,useSimplifiedPhysics:!0,maxFrameRate:30,drawDistance:100,animationFrameskip:3,backgroundEnabled:!1,reflectionQuality:"none",lightingQuality:"basic",maxTrainingObjects:5},[k.LOW]:{avatarSegments:12,environmentDetail:"low",maxCyclists:3,textureQuality:"low",shadowsEnabled:!1,effectsEnabled:!1,useSimplifiedPhysics:!0,maxFrameRate:45,drawDistance:200,animationFrameskip:2,backgroundEnabled:!0,reflectionQuality:"none",lightingQuality:"basic",maxTrainingObjects:10},[k.MEDIUM]:{avatarSegments:16,environmentDetail:"medium",maxCyclists:5,textureQuality:"medium",shadowsEnabled:!0,effectsEnabled:!0,useSimplifiedPhysics:!1,maxFrameRate:60,drawDistance:500,animationFrameskip:0,backgroundEnabled:!0,reflectionQuality:"low",lightingQuality:"standard",maxTrainingObjects:20},[k.HIGH]:{avatarSegments:24,environmentDetail:"high",maxCyclists:8,textureQuality:"high",shadowsEnabled:!0,effectsEnabled:!0,useSimplifiedPhysics:!1,maxFrameRate:90,drawDistance:1e3,animationFrameskip:0,backgroundEnabled:!0,reflectionQuality:"medium",lightingQuality:"advanced",maxTrainingObjects:40},[k.ULTRA_HIGH]:{avatarSegments:32,environmentDetail:"ultra",maxCyclists:12,textureQuality:"ultra",shadowsEnabled:!0,effectsEnabled:!0,useSimplifiedPhysics:!1,maxFrameRate:120,drawDistance:2e3,animationFrameskip:0,backgroundEnabled:!0,reflectionQuality:"high",lightingQuality:"physically-based",maxTrainingObjects:60}}},this.mobileOverrides={shadowsEnabled:!1,postProcessingEnabled:!1,ambientOcclusionEnabled:!1,reflectionsEnabled:!1,drawDistance:.6,maxParticles:.3,maxFrameRate:Math.min,backgroundDetail:e=>Math.max(k.LOW,e-1)},this.batterySavingOverrides={shadowsEnabled:!1,postProcessingEnabled:!1,maxFrameRate:30,drawDistance:.5,terrainSegments:.5,textureQuality:e=>Math.max(k.ULTRA_LOW,e-2)}}getOptimalConfig(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const i=z.getCapabilities();let a=i.performanceLevel;this.configs[e]||(console.warn(`3DConfigManager: configuration non trouv\xe9e pour ${e}`),e="colVisualization");let s={...this.configs[e][a]};return(i.flags.isMobile||t.forceMobileMode)&&(s=this.applyMobileOverrides(s,a)),(i.flags.hasBatteryConstraints||t.forceBatterySaving)&&(s=this.applyBatterySavingOverrides(s,a)),t.userOverrides&&(s={...s,...t.userOverrides}),s=this.sanitizeConfig(s),s}applyMobileOverrides(e,t){const i={...e};return Object.entries(this.mobileOverrides).forEach((a=>{let[s,r]=a;"function"===typeof r?i[s]=r(t):"number"===typeof r&&void 0!==e[s]?i[s]=Math.round(e[s]*r):i[s]=r})),i}applyBatterySavingOverrides(e,t){const i={...e};return Object.entries(this.batterySavingOverrides).forEach((a=>{let[s,r]=a;"function"===typeof r?i[s]=r(t):"number"===typeof r&&void 0!==e[s]?i[s]=Math.round(e[s]*r):i[s]=r})),i}sanitizeConfig(e){const t={...e};return t.terrainSegments&&(t.terrainSegments=Math.max(32,t.terrainSegments)),t.textureSize&&(t.textureSize=Math.max(256,t.textureSize)),t.drawDistance&&(t.drawDistance=Math.max(100,t.drawDistance)),t.maxFrameRate&&(t.maxFrameRate=Math.max(24,t.maxFrameRate)),t}generateConfigSummary(e){if(!e)return"Configuration non disponible";let t=0,i=0;[{prop:"terrainSegments",high:256,low:64},{prop:"textureSize",high:2048,low:512},{prop:"shadowsEnabled",binary:!0},{prop:"postProcessingEnabled",binary:!0}].forEach((a=>{if(void 0!==e[a.prop])if(a.binary)t+=e[a.prop]?1:0,i+=1;else{const s=Math.min(1,Math.max(0,(e[a.prop]-a.low)/(a.high-a.low)));t+=s,i+=1}}));const a=Math.round(t/Math.max(1,i)*100);let s="Moyen";return a>=75?s="\xc9lev\xe9":a<=30&&(s="Faible"),`Qualit\xe9 visuelle: ${s} (${a}%)\nD\xe9tail terrain: ${e.terrainSegments||"N/A"}\nR\xe9solution textures: ${e.textureSize||"N/A"}\nOmbres: ${e.shadowsEnabled?"Activ\xe9es":"D\xe9sactiv\xe9es"}\nEffets visuels: ${e.postProcessingEnabled?"Activ\xe9s":"D\xe9sactiv\xe9s"}`}};const F=new class{constructor(){this.isMobile=this.detectMobile(),this.isTablet=this.detectTablet(),this.initialized=!1,this.optimizations={reducedResolution:!0,simplifiedEffects:!0,batterySaveMode:!1,optimizedControls:!0,progressiveLoading:!0,optimizedInteraction:!0,reducedAnimations:!1,adaptiveQuality:!0},this.originalPixelRatio=window.devicePixelRatio||1,this.currentPixelRatio=this.originalPixelRatio,this.performanceMetrics={frameRate:60,frameHistory:[],dropCount:0,lastPerformanceCheck:Date.now()},this.adaptiveQualityMetrics={targetFPS:45,minFPS:30,adjustmentCooldown:5e3,lastAdjustment:0,currentQualityMultiplier:1},this.initialize()}initialize(){"complete"===document.readyState?this.setupEventListeners():window.addEventListener("load",(()=>this.setupEventListeners()))}setupEventListeners(){window.addEventListener("orientationchange",(()=>{this.handleOrientationChange()})),document.addEventListener("visibilitychange",(()=>{this.handleVisibilityChange()})),navigator.getBattery&&navigator.getBattery().then((e=>{e.addEventListener("levelchange",(()=>{this.checkBatteryStatus(e)})),e.addEventListener("chargingchange",(()=>{this.checkBatteryStatus(e)})),this.checkBatteryStatus(e)})),this.setupPerformanceMonitoring(),this.initialized=!0}detectMobile(){return/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(navigator.userAgent||navigator.vendor||window.opera)}detectTablet(){return/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(ad|hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(navigator.userAgent||navigator.vendor||window.opera)&&!this.detectMobile()}needsMobileOptimizations(){const e=z.getCapabilities();return this.isMobile||this.isTablet||e.flags.isLowEndDevice||e.performanceLevel<=2}optimizeRenderer(e){if(!this.needsMobileOptimizations())return e;if(this.optimizations.reducedResolution){const t=z.getCapabilities();let i=1;const{width:a,height:s}=t.screen.effectiveResolution,r=a*s;i=r>4e6?.5:r>2e6?.65:r>1e6?.75:.85,this.optimizations.batterySaveMode&&(i*=.7),this.currentPixelRatio=this.originalPixelRatio*i,e.setPixelRatio(this.currentPixelRatio),console.log(`MobileOptimizer: pixel ratio r\xe9duit de ${this.originalPixelRatio} \xe0 ${this.currentPixelRatio}`)}return this.optimizations.simplifiedEffects&&(e.antialias&&console.warn("MobileOptimizer: impossible de d\xe9sactiver l'antialiasing apr\xe8s la cr\xe9ation du renderer"),e.capabilities&&"highp"===e.capabilities.precision&&(e.capabilities.precision="mediump"),e.shadowMap&&e.shadowMap.enabled&&(e.shadowMap.enabled=!1)),e}setupOptimizedTouchControls(e){return this.needsMobileOptimizations()&&this.optimizations.optimizedControls?(e.domElement&&e.domElement.style&&(e.domElement.style.touchAction="none"),void 0!==e.rotateSpeed&&(e.rotateSpeed=.8),void 0!==e.zoomSpeed&&(e.zoomSpeed=1.2),void 0!==e.panSpeed&&(e.panSpeed=.8),void 0!==e.enableDamping&&(e.enableDamping=!1),void 0!==e.minDistance&&(e.minDistance*=1.2),void 0!==e.noRotate&&(e.rotateSpeed=2),void 0!==e.movementSpeed&&(e.movementSpeed*=.7),e):e}enableBatterySaveMode(e,t){if(!this.needsMobileOptimizations())return t;this.optimizations.batterySaveMode=!0;const i=.7*this.currentPixelRatio;e.setPixelRatio(i);let a=0;const s=1e3/30,r=e=>{const i=e||performance.now(),n=i-a;n>s&&(a=i-n%s,t(i)),this.optimizations.batterySaveMode?setTimeout((()=>requestAnimationFrame(r)),5):requestAnimationFrame(r)};return console.log("MobileOptimizer: mode \xe9conomie de batterie activ\xe9"),r}handleOrientationChange(){setTimeout((()=>{this.adjustForCurrentContext();const e=new CustomEvent("optimized-orientation-change",{detail:{orientation:window.orientation,aspectRatio:window.innerWidth/window.innerHeight}});window.dispatchEvent(e)}),300)}handleVisibilityChange(){document.hidden?this.pauseNonEssentialProcesses():this.resumeNonEssentialProcesses()}checkBatteryStatus(e){const t=!e.charging&&e.level<.3;t!==this.optimizations.batterySaveMode&&(this.optimizations.batterySaveMode=t,t?console.log("MobileOptimizer: niveau de batterie bas, optimisations accrues activ\xe9es"):console.log("MobileOptimizer: niveau de batterie normal, optimisations standard"),window.dispatchEvent(new CustomEvent("battery-status-change",{detail:{low:t,level:e.level,charging:e.charging}})))}pauseNonEssentialProcesses(){this._pausedState={adaptiveQuality:this.optimizations.adaptiveQuality,reducedResolution:this.optimizations.reducedResolution},this.optimizations.adaptiveQuality=!1,this.optimizations.reducedResolution=!0,console.log("MobileOptimizer: pause des processus non essentiels"),window.dispatchEvent(new CustomEvent("optimization-state-change",{detail:{state:"paused",optimizations:this.optimizations}}))}resumeNonEssentialProcesses(){this._pausedState&&(this.optimizations.adaptiveQuality=this._pausedState.adaptiveQuality,this.optimizations.reducedResolution=this._pausedState.reducedResolution,console.log("MobileOptimizer: reprise des processus non essentiels"),window.dispatchEvent(new CustomEvent("optimization-state-change",{detail:{state:"resumed",optimizations:this.optimizations}})))}setupPerformanceMonitoring(){if(!this.optimizations.adaptiveQuality)return;let e=performance.now(),t=0;const i=()=>{const a=performance.now();if(t++,a-e>=1e3){const i=Math.round(1e3*t/(a-e));this.performanceMetrics.frameHistory.push(i),this.performanceMetrics.frameHistory.length>60&&this.performanceMetrics.frameHistory.shift();const s=this.performanceMetrics.frameHistory.reduce(((e,t)=>e+t),0)/this.performanceMetrics.frameHistory.length;this.performanceMetrics.frameRate=Math.round(s),i<this.adaptiveQualityMetrics.minFPS?(this.performanceMetrics.dropCount++,this.performanceMetrics.dropCount>=3&&(this.adjustQualityBasedOnPerformance(),this.performanceMetrics.dropCount=0)):this.performanceMetrics.dropCount=Math.max(0,this.performanceMetrics.dropCount-1);a-this.adaptiveQualityMetrics.lastAdjustment>this.adaptiveQualityMetrics.adjustmentCooldown&&this.performanceMetrics.frameRate>this.adaptiveQualityMetrics.targetFPS+10&&this.increaseQuality(),e=a,t=0}requestAnimationFrame(i)};i()}adjustQualityBasedOnPerformance(){const e=performance.now();e-this.adaptiveQualityMetrics.lastAdjustment<this.adaptiveQualityMetrics.adjustmentCooldown||(this.adaptiveQualityMetrics.currentQualityMultiplier*=.8,this.adaptiveQualityMetrics.currentQualityMultiplier=Math.max(.4,this.adaptiveQualityMetrics.currentQualityMultiplier),this.adaptiveQualityMetrics.lastAdjustment=e,console.log(`MobileOptimizer: r\xe9duction de la qualit\xe9 \xe0 ${Math.round(100*this.adaptiveQualityMetrics.currentQualityMultiplier)}% pour maintenir les performances`),window.dispatchEvent(new CustomEvent("quality-adjustment",{detail:{qualityMultiplier:this.adaptiveQualityMetrics.currentQualityMultiplier,reason:"performance-drop",frameRate:this.performanceMetrics.frameRate}})))}increaseQuality(){const e=performance.now();e-this.adaptiveQualityMetrics.lastAdjustment<this.adaptiveQualityMetrics.adjustmentCooldown||(this.adaptiveQualityMetrics.currentQualityMultiplier*=1.1,this.adaptiveQualityMetrics.currentQualityMultiplier=Math.min(1,this.adaptiveQualityMetrics.currentQualityMultiplier),this.adaptiveQualityMetrics.lastAdjustment=e,console.log(`MobileOptimizer: augmentation de la qualit\xe9 \xe0 ${Math.round(100*this.adaptiveQualityMetrics.currentQualityMultiplier)}% gr\xe2ce aux bonnes performances`),window.dispatchEvent(new CustomEvent("quality-adjustment",{detail:{qualityMultiplier:this.adaptiveQualityMetrics.currentQualityMultiplier,reason:"performance-good",frameRate:this.performanceMetrics.frameRate}})))}adjustForCurrentContext(){const e=z.getCapabilities(),t=window.innerWidth>window.innerHeight;this.optimizations.reducedResolution=!t||this.isMobile,"2g"!==e.network.effectiveType&&"slow-2g"!==e.network.effectiveType||(this.optimizations.progressiveLoading=!0,this.optimizations.reducedAnimations=!0),console.log("MobileOptimizer: ajustement des optimisations au contexte actuel")}getShaderOptimizationConfig(){const e={precision:"mediump",optimizeLoops:this.needsMobileOptimizations(),simplifyLighting:this.needsMobileOptimizations(),maxLights:this.optimizations.batterySaveMode?2:4};return this.optimizations.batterySaveMode&&(e.precision="lowp"),e}setupProgressiveTextureLoading(e){if(!e)return null;const t=z.getCapabilities(),i=t.flags.isLowEndDevice||t.performanceLevel<=2;return{loadTexture:(t,a)=>new Promise((s=>{let r=["low","high"];(i||this.optimizations.batterySaveMode)&&(r=["low"]);const n=r.map((e=>{const i=new URL(t,window.location.href).pathname.split("."),a=i.pop();return"low"===e?`${i.join(".")}_low.${a}`:t}));e.load(n[0],(t=>{1!==r.length&&this.optimizations.progressiveLoading?(e.load(n[1],(e=>{s({texture:e,quality:"high",lowQualityTexture:t})}),a),s({texture:t,quality:"low",pendingHighQuality:!0})):s({texture:t,quality:"low"})}),a)}))}}};const U=new class{constructor(){this.batteryData={isSupported:!1,level:1,charging:!0,dischargingTime:1/0},this.listeners=[],this.batteryModeActive=!1,this.initialized=!1,this.batterySavingConfig={maxPixelRatio:1,shadowsEnabled:!1,useSimplifiedGeometry:!0,minimizeObjects:!0,maxDistanceMarkers:5,antialias:!1,maxLights:1,useLowResTextures:!0,disablePostProcessing:!0,throttleFPS:!0,targetFPS:30,enableFrustumCulling:!0},this.thresholds={lowBatteryLevel:.3,criticalBatteryLevel:.15,dischargingTimeWarning:1800},this.autoEnableBatteryMode=!0}async initialize(){if(this.initialized)return this.batteryData.isSupported;if("getBattery"in navigator)try{const e=await navigator.getBattery();this.batteryData.isSupported=!0,this.updateBatteryInfo(e),e.addEventListener("levelchange",(()=>this.updateBatteryInfo(e))),e.addEventListener("chargingchange",(()=>this.updateBatteryInfo(e))),e.addEventListener("dischargingtimechange",(()=>this.updateBatteryInfo(e))),this.checkBatteryStatus(),console.log("BatteryOptimizer: API Battery initialis\xe9e avec succ\xe8s")}catch(e){console.error("BatteryOptimizer: Erreur lors de l'initialisation de l'API Battery",e),this.batteryData.isSupported=!1}else console.log("BatteryOptimizer: API Battery non support\xe9e par ce navigateur"),this.batteryData.isSupported=!1;return this.initialized=!0,this.batteryData.isSupported}updateBatteryInfo(e){const t=this.batteryData.level,i=this.batteryData.charging;this.batteryData.level=e.level,this.batteryData.charging=e.charging,this.batteryData.dischargingTime=e.dischargingTime;(Math.abs(t-e.level)>.05||i!==e.charging)&&(this.notifyListeners(),this.checkBatteryStatus())}checkBatteryStatus(){if(this.batteryData.isSupported&&this.autoEnableBatteryMode)return this.batteryData.charging&&this.batteryModeActive?(this.setBatteryMode(!1),void console.log("BatteryOptimizer: Appareil en charge, d\xe9sactivation du mode \xe9conomie de batterie")):void(this.batteryData.charging||(this.batteryData.level<=this.thresholds.lowBatteryLevel&&!this.batteryModeActive&&(this.setBatteryMode(!0),console.log(`BatteryOptimizer: Batterie faible (${Math.round(100*this.batteryData.level)}%), activation du mode \xe9conomie`)),this.batteryData.level<=this.thresholds.criticalBatteryLevel&&console.log(`BatteryOptimizer: Niveau de batterie critique (${Math.round(100*this.batteryData.level)}%), optimisations maximales`)))}setBatteryMode(e){this.batteryModeActive!==e&&(this.batteryModeActive=e,this.notifyListeners(),"undefined"!==typeof localStorage&&localStorage.setItem("batteryModeEnabled",e?"true":"false"),console.log("BatteryOptimizer: Mode \xe9conomie de batterie "+(e?"activ\xe9":"d\xe9sactiv\xe9")))}getBatterySavingConfig(){return this.batteryModeActive?this.batteryData.level<=this.thresholds.criticalBatteryLevel?{...this.batterySavingConfig,maxPixelRatio:.75,targetFPS:20,minimizeObjects:!0}:this.batterySavingConfig:null}isBatteryModeActive(){return this.batteryModeActive}getBatteryData(){return{...this.batteryData}}addListener(e){"function"!==typeof e||this.listeners.includes(e)||this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter((t=>t!==e))}notifyListeners(){this.listeners.forEach((e=>{try{e({batteryData:this.getBatteryData(),batteryModeActive:this.batteryModeActive,config:this.getBatterySavingConfig()})}catch(t){console.error("BatteryOptimizer: Erreur lors de la notification d'un \xe9couteur",t)}}))}setAutoMode(e){this.autoEnableBatteryMode=e,e&&this.checkBatteryStatus(),"undefined"!==typeof localStorage&&localStorage.setItem("batteryAutoMode",e?"true":"false")}loadUserPreferences(){if("undefined"!==typeof localStorage){"true"===localStorage.getItem("batteryModeEnabled")&&this.setBatteryMode(!0);const e=localStorage.getItem("batteryAutoMode");null!==e&&this.setAutoMode("true"===e)}}};"undefined"!==typeof window&&window.addEventListener("load",(()=>{U.initialize().then((()=>{U.loadUserPreferences()}))}));const j=U;var B=i(70579);const H=e=>{let{passId:t,elevationData:i,surfaceTypes:g,pointsOfInterest:v}=e;const b=(0,a.useRef)(null),[w,M]=(0,a.useState)(!0),[x,E]=(0,a.useState)(null),[T,P]=(0,a.useState)(null),[A,I]=(0,a.useState)([]),[O,k]=(0,a.useState)(L),[U,H]=(0,a.useState)("free"),[Q,G]=(0,a.useState)({viewpoint:!0,restaurant:!0,landmark:!0,parking:!0,danger:!0}),[W,N]=(0,a.useState)(null),[$,V]=(0,a.useState)(null),[q,K]=(0,a.useState)(!0),[J,X]=(0,a.useState)(!1),Y=(0,a.useRef)(null),Z=(0,a.useRef)(null),ee=(0,a.useRef)(null),te=(0,a.useRef)({frameRate:0,frameRateHistory:[],lastFrameTime:0,frameCount:0,lastPerformanceAdjustment:0}),[ie,ae]=(0,a.useState)({difficulty:"Difficile",length:"12.5 km",elevationGain:"850 m"});(0,a.useEffect)((()=>((async()=>{try{if(M(!0),E(null),P(null),!i||!g){if(!await S.get(`/api/cols/${t}`,{strategy:y}))return E("Impossible de charger les donn\xe9es du col"),void M(!1)}const e=await z.getCapabilities();N(e);const a=_.getOptimalConfig("colVisualization",{forceBatterySaving:J});V(a),k(R.getDetailLevelFromString(a.modelDetailLevel)),ee.current||(ee.current=F.setupProgressiveTextureLoading(new s.TextureLoader)),i&&i.path&&initializeFlyThroughPath(),q&&re(),await j.initialize(),X(j.isBatteryModeActive()),M(!1)}catch(e){console.error("Erreur lors de l'initialisation de la visualisation:",e),E("Une erreur est survenue lors du chargement de la visualisation 3D"),M(!1)}})(),()=>{flyThroughAnimationRef.current&&cancelAnimationFrame(flyThroughAnimationRef.current),Z.current&&Z.current.dispose()})),[t,i,v,J,q]),(0,a.useEffect)((()=>{if(!v||!Array.isArray(v))return void I([]);const e=Object.values(Q).every((e=>!1===e))?v:v.filter((e=>e&&e.type&&Q[e.type]));I(e)}),[Q,v]);const se=(0,a.useCallback)((e=>{k(e);const t={...$};t.modelDetailLevel=R.getStringFromDetailLevel(e),V(t),K(!1)}),[$]),re=(0,a.useCallback)((()=>{const e=e=>{const{qualityMultiplier:t,reason:i}=e.detail;if(!$)return;let a=O;if(a=t<=.5?C:t<=.8?L:D,a!==O){k(a);const e={...$};e.modelDetailLevel=R.getStringFromDetailLevel(a),V(e),console.log(`Ajustement automatique de la qualit\xe9: ${R.getStringFromDetailLevel(a)} (${i})`)}};return window.addEventListener("quality-adjustment",e),()=>{window.removeEventListener("quality-adjustment",e)}}),[O,$]),ne=(0,a.useCallback)((()=>{const e=!J;X(e);const t=_.getOptimalConfig("colVisualization",{forceBatterySaving:e});V(t),k(R.getDetailLevelFromString(t.modelDetailLevel)),console.log("Mode \xe9conomie de batterie "+(e?"activ\xe9":"d\xe9sactiv\xe9")),j.setBatteryMode(e)}),[J]),oe=()=>{const{gl:e,camera:t}=(0,r.D)();return(0,a.useEffect)((()=>(Z.current=e,W&&(W.flags.isMobile||W.flags.isLowEndDevice)&&F.optimizeRenderer(e),$&&($.shadowsEnabled?(e.shadowMap.enabled=!0,e.shadowMap.type=s.PCFSoftShadowMap,e.shadowMap.autoUpdate=!1,e.shadowMap.needsUpdate=!0):e.shadowMap.enabled=!1,e.setClearColor(new s.Color("#87CEEB"),1),$.maxFrameRate&&$.maxFrameRate<60&&e.setAnimationLoop((i=>{i-te.current.lastFrameTime>=1e3/$.maxFrameRate&&(te.current.lastFrameTime=i,e.render(e.scene,t))}))),()=>{e.setAnimationLoop&&e.setAnimationLoop(null)})),[e,t,W,$]),(0,r.F)(((e,t)=>{if(!q)return;te.current.frameCount++;const i=performance.now(),a=i-te.current.lastPerformanceCheck;if(a>1e3){const e=Math.round(1e3*te.current.frameCount/a);te.current.frameRate=e,te.current.frameRateHistory.push(e),te.current.frameRateHistory.length>10&&te.current.frameRateHistory.shift(),te.current.frameCount=0,te.current.lastPerformanceCheck=i}})),null};return(0,B.jsx)(l.A,{elevation:3,sx:{mb:4,overflow:"hidden",position:"relative"},children:(0,B.jsx)(VisualizationContainer,{children:x?(0,B.jsx)(StyledAlert,{severity:"error",children:x}):w?(0,B.jsx)(LoadingOverlay,{children:(0,B.jsx)(LoadingIndicator,{})}):(0,B.jsxs)(B.Fragment,{children:[(0,B.jsxs)(n.Hl,{ref:b,camera:{position:[0,10,20],fov:60},shadows:!!$&&$.shadowsEnabled,dpr:window.devicePixelRatio>2?2:window.devicePixelRatio,performance:{min:.5},children:[(0,B.jsx)(oe,{}),(0,B.jsx)("ambientLight",{intensity:.5}),(0,B.jsx)("directionalLight",{position:[10,20,10],intensity:.8,castShadow:!!$&&$.shadowsEnabled,"shadow-mapSize-width":$&&$.shadowMapSize||1024,"shadow-mapSize-height":$&&$.shadowMapSize||1024}),(0,B.jsx)(Terrain,{elevationData:i,surfaceTypes:g,detailLevel:O,renderConfig:$}),A.slice(0,$?$.maxPointsOfInterest:25).map(((e,t)=>(0,B.jsx)(PointOfInterest,{position:[e.x,.1*(e.elevation||0)+1,e.z],label:e.name,type:e.type,isSelected:T===e,onClick:()=>handleSelectPOI(e),detailLevel:O},`poi-${t}`))),(0,B.jsx)(o.N,{ref:Y,enableDamping:!$||!$.useSimplifiedGeometry,dampingFactor:.1,minDistance:5,maxDistance:100,target:T?[T.x,.1*(T.elevation||0),T.z]:[0,0,0],touchAction:"none",touches:{ONE:s.TOUCH.ROTATE,TWO:s.TOUCH.DOLLY_PAN},...null!==W&&void 0!==W&&W.flags.isMobile?{rotateSpeed:.8,zoomSpeed:1.2,panSpeed:.8}:{}}),"flythrough"===U&&(0,B.jsx)(FlyThroughCamera,{})]}),(0,B.jsxs)(OverlayContainer,{children:[(0,B.jsxs)(c.A,{sx:{p:1.5},children:[(0,B.jsx)(d.A,{variant:"subtitle2",sx:{mb:1},children:"Visualisation 3D"}),(0,B.jsxs)(c.A,{sx:{display:"flex",alignItems:"center",mb:1},children:[(0,B.jsx)(d.A,{variant:"body2",sx:{mr:1},children:"Qualit\xe9:"}),(0,B.jsxs)(h.A,{size:"small",children:[(0,B.jsx)(u.A,{variant:O===C?"contained":"outlined",onClick:()=>se(C),children:"Basse"}),(0,B.jsx)(u.A,{variant:O===L?"contained":"outlined",onClick:()=>se(L),children:"Moyenne"}),(0,B.jsx)(u.A,{variant:O===D?"contained":"outlined",onClick:()=>se(D),disabled:null===W||void 0===W?void 0:W.flags.isLowEndDevice,children:"Haute"})]})]}),(0,B.jsxs)(c.A,{sx:{display:"flex",alignItems:"center",mb:1},children:[(0,B.jsx)(AdaptiveQualityFlag,{active:q,onClick:()=>K(!q),children:"Auto"}),(0,B.jsx)(AdaptiveQualityFlag,{active:J,onClick:ne,children:"\xc9co"}),f.Ay.isEnabled("showPerformanceMetrics")&&(0,B.jsxs)(d.A,{variant:"caption",sx:{ml:1},children:[te.current.frameRate," FPS"]})]}),(0,B.jsx)(m.A,{sx:{my:1}}),(0,B.jsx)(d.A,{variant:"body2",sx:{mb:1},children:"Cam\xe9ra:"}),(0,B.jsxs)(h.A,{size:"small",sx:{mb:1},children:[(0,B.jsx)(u.A,{variant:"free"===U?"contained":"outlined",onClick:()=>handleViewChange("free"),children:"Libre"}),(0,B.jsx)(u.A,{variant:"overview"===U?"contained":"outlined",onClick:()=>handleViewChange("overview"),children:"Vue d'ensemble"}),(0,B.jsx)(u.A,{variant:"flythrough"===U?"contained":"outlined",onClick:()=>handleViewChange("flythrough"),startIcon:(0,B.jsx)(p.A,{}),disabled:(null===W||void 0===W?void 0:W.flags.isLowEndDevice)&&(null===$||void 0===$?void 0:$.useSimplifiedGeometry),children:"Parcours"})]}),(0,B.jsx)(m.A,{sx:{my:1}}),(0,B.jsx)(d.A,{variant:"body2",sx:{mb:1},children:"Filtre des points d'int\xe9r\xeat:"}),(0,B.jsxs)(c.A,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:[(0,B.jsx)(PoiFilterChip,{active:Q.viewpoint,onClick:()=>handlePOIFilterChange("viewpoint"),children:"Panoramas"}),(0,B.jsx)(PoiFilterChip,{active:Q.restaurant,onClick:()=>handlePOIFilterChange("restaurant"),children:"Restaurants"}),(0,B.jsx)(PoiFilterChip,{active:Q.landmark,onClick:()=>handlePOIFilterChange("landmark"),children:"Points remarquables"}),(0,B.jsx)(PoiFilterChip,{active:Q.parking,onClick:()=>handlePOIFilterChange("parking"),children:"Parkings"}),(0,B.jsx)(PoiFilterChip,{active:Q.danger,onClick:()=>handlePOIFilterChange("danger"),children:"Zones dangereuses"})]})]}),f.Ay.isEnabled("showDeviceCapabilities")&&W&&(0,B.jsxs)(c.A,{sx:{p:1.5,borderTop:"1px solid rgba(0,0,0,0.1)"},children:[(0,B.jsxs)(d.A,{variant:"caption",component:"div",children:["Appareil: ",W.flags.isMobile?"Mobile":W.flags.isTablet?"Tablette":"Desktop"]}),(0,B.jsxs)(d.A,{variant:"caption",component:"div",children:["GPU: ",W.gpu.vendor?W.gpu.vendor.split(" ")[0]:"Non d\xe9tect\xe9"," (",Math.round(W.gpu.estimatedMemory),"MB)"]}),(0,B.jsxs)(d.A,{variant:"caption",component:"div",children:["CPU: ",W.cpu.cores," c\u0153urs"]}),(0,B.jsxs)(d.A,{variant:"caption",component:"div",children:["R\xe9seau: ",W.network.effectiveType]})]})]}),(0,B.jsxs)(TrailInfoContainer,{children:[(0,B.jsxs)(TrailInfoItem,{children:[(0,B.jsx)(d.A,{variant:"caption",children:"Difficult\xe9"}),(0,B.jsx)(d.A,{variant:"body2",sx:{fontWeight:"bold"},children:ie.difficulty})]}),(0,B.jsxs)(TrailInfoItem,{children:[(0,B.jsx)(d.A,{variant:"caption",children:"Distance"}),(0,B.jsx)(d.A,{variant:"body2",sx:{fontWeight:"bold"},children:ie.length})]}),(0,B.jsxs)(TrailInfoItem,{children:[(0,B.jsx)(d.A,{variant:"caption",children:"D\xe9nivel\xe9"}),(0,B.jsx)(d.A,{variant:"body2",sx:{fontWeight:"bold"},children:ie.elevationGain})]})]})]})})})}},34372:(e,t,i)=>{i.d(t,{Ay:()=>h,h:()=>d});var a=i(86213),s=i(65043);i(70579);const r={enableDarkMode:!1,showBetaFeatures:!1,useNewNavigation:!1,enableSevenMajorsChallenge:!0,enableMonthlyChallenge:!0,enableSocialSharing:!0,enableApiCaching:!0,enablePerformanceMonitoring:!0,enable3DColVisualization:!0,enableProgressiveLoading3D:!0,enableAIRecommendations:!1,enableRealTimeWeather:!0,enableAdvancedCaching:!0,enableOfflineMode:!1,enableLazyLoadingImages:!0,enableAdvancedMetrics:!0,enableBulkOperations:!1,enableNutritionPlanner:!0,enableMealSuggestions:!0,enableColSpecificNutrition:!0,enableTrainingPrograms:!0,enablePerformanceAnalytics:!0,enableColSpecificTraining:!0,enableMountainModule:!0,enableRegionalTrainingPlans:!0},n="development",o="production",l=(0,s.createContext)({flags:r,isLoading:!0,error:null,updateFlag:()=>{},refreshFlags:()=>{},isEnabled:()=>!1,getVariant:()=>null});const c=new class{constructor(){this.flags={...r},this.subscribers=[],this.isInitialized=!1,this.lastFetchTime=0,this.cacheDuration=3e5,this.environment="production",this.userSegment=null,this.flagsHistory={}}async initialize(){if(this.isInitialized)return this.flags;try{return this.determineUserSegment(),await this.loadFlagsFromLocalStorage(),await this.fetchFlagsFromApi(),this.applyEnvironmentOverrides(),Object.keys(this.flags).forEach((e=>{this.flagsHistory[e]=[{value:this.flags[e],timestamp:Date.now(),source:"initialization"}]})),this.isInitialized=!0,this.notifySubscribers(),this.flags}catch(e){return console.error("Erreur lors de l'initialisation des feature flags:",e),this.flags}}determineUserSegment(){try{const e=JSON.parse(localStorage.getItem("userInfo")||"{}");if("admin"===e.role)this.userSegment="admin";else if(e.visits&&e.visits>10)this.userSegment="power_user";else if(e.registeredAt){const t=new Date(e.registeredAt),i=new Date;i.setMonth(i.getMonth()-1),this.userSegment=t>i?"new_user":"regular_user"}else this.userSegment="anonymous"}catch(e){console.error("Erreur lors de la d\xe9termination du segment utilisateur:",e),this.userSegment="unknown"}}applyEnvironmentOverrides(){if(this.environment===o){const e={showBetaFeatures:!1,enableAIRecommendations:!1};Object.keys(e).forEach((t=>{this.flagsHistory[t]&&0!==this.flagsHistory[t].length||(this.flags[t]=e[t])}))}if(this.environment===n){const e={showBetaFeatures:!0,enablePerformanceMonitoring:!0};Object.assign(this.flags,e)}}async loadFlagsFromLocalStorage(){try{const e=localStorage.getItem("featureFlags");if(e){const t=JSON.parse(e);this.flags={...this.flags,...t},Object.keys(t).forEach((e=>{this.flagsHistory[e]||(this.flagsHistory[e]=[]),this.flagsHistory[e].push({value:t[e],timestamp:Date.now(),source:"localStorage"})}))}}catch(e){console.error("Erreur lors du chargement des feature flags du localStorage:",e)}}async fetchFlagsFromApi(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const t=Date.now();if(!e&&t-this.lastFetchTime<this.cacheDuration)return this.flags;try{const e=await a.A.get("/api/feature-flags",{params:{segment:this.userSegment,environment:this.environment}});if(e.data&&e.data.flags){const i={...this.flags};this.flags={...this.flags,...e.data.flags},this.lastFetchTime=t,localStorage.setItem("featureFlags",JSON.stringify(this.flags)),Object.keys(e.data.flags).forEach((a=>{this.flagsHistory[a]||(this.flagsHistory[a]=[]),this.flagsHistory[a].push({value:e.data.flags[a],previousValue:i[a],timestamp:t,source:"api"})})),this.notifySubscribers(),this.logFlagChanges(i,this.flags)}}catch(i){console.error("Erreur lors de la r\xe9cup\xe9ration des feature flags depuis l'API:",i)}return this.flags}logFlagChanges(e,t){const i=[];Object.keys(t).forEach((a=>{e[a]!==t[a]&&i.push({flag:a,oldValue:e[a],newValue:t[a],timestamp:Date.now()})})),i.length>0&&(console.info("Feature Flags mis \xe0 jour:",i),this.environment===n&&"undefined"!==typeof window&&this.showDevNotification(`${i.length} feature flags mis \xe0 jour`))}showDevNotification(e){if("undefined"===typeof document)return;const t="feature-flag-notification";let i=document.getElementById(t);i||(i=document.createElement("div"),i.id=t,i.style.position="fixed",i.style.bottom="20px",i.style.right="20px",i.style.padding="10px 15px",i.style.backgroundColor="#333",i.style.color="white",i.style.borderRadius="4px",i.style.zIndex="9999",i.style.opacity="0",i.style.transition="opacity 0.3s ease-in-out",document.body.appendChild(i)),i.textContent=e,i.style.opacity="1",setTimeout((()=>{i.style.opacity="0",setTimeout((()=>{i.parentNode&&i.parentNode.removeChild(i)}),300)}),3e3)}async updateFlags(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const i={...this.flags};if(this.flags={...this.flags,...e},localStorage.setItem("featureFlags",JSON.stringify(this.flags)),Object.keys(e).forEach((t=>{this.flagsHistory[t]||(this.flagsHistory[t]=[]),this.flagsHistory[t].push({value:e[t],previousValue:i[t],timestamp:Date.now(),source:"manual_update"})})),this.logFlagChanges(i,this.flags),this.notifySubscribers(),t)try{await a.A.post("/api/feature-flags",{flags:e,segment:this.userSegment,environment:this.environment})}catch(s){console.error("Erreur lors de la mise \xe0 jour des feature flags sur le serveur:",s)}return this.flags}isEnabled(e){return e in this.flags?!0===this.flags[e]:(console.warn(`Feature flag "${e}" non trouv\xe9`),!1)}getVariant(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return e in this.flags?this.flags[e]:(console.warn(`Feature flag variant "${e}" non trouv\xe9`),t)}subscribe(e){return this.subscribers.push(e),()=>{this.subscribers=this.subscribers.filter((t=>t!==e))}}notifySubscribers(){this.subscribers.forEach((e=>{try{e(this.flags)}catch(t){console.error("Erreur lors de la notification d'un abonn\xe9 aux feature flags:",t)}}))}getFlagHistory(e){return this.flagsHistory[e]||[]}setCacheDuration(e){this.cacheDuration=e}},d=()=>{const e=(0,s.useContext)(l);if(!e)throw new Error("useFeatureFlags doit \xeatre utilis\xe9 \xe0 l'int\xe9rieur d'un FeatureFlagsProvider");return e},h=c}}]);
//# sourceMappingURL=4222.6db9d8b1.chunk.js.map