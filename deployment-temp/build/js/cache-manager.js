const CacheManager=function(){let e={defaultTTL:3600,ttlConfig:{weather:1800,forecast:7200,routes:86400,elevation:2592e3,stravaAthleteStats:43200,stravaActivities:3600,cols:2592e3},maxCacheSize:10485760,evictionStrategy:"lru",progressiveCache:{enabled:!0,criticalDataTTL:{weather:3600,routes:604800,stravaActivities:7200},criticalDataKeys:["temperature","condition","summary","distance","duration","elevation","difficulty","name","coordinates","athleteId"],priority:{weather:1,routes:2,elevation:2,stravaActivities:3,cols:1}},backgroundSync:{enabled:!0,interval:18e5,syncOnNetworkChange:!0,maxRetries:3,respectBatteryStatus:!0,onlyWhenIdle:!1},apiRateLimit:{enabled:!0,quotaPerApi:{weather:1e3,mapbox:5e4,strava:100,openroute:500},conserveQuota:.1}},t={hits:0,misses:0,evictions:0,size:0,lastCleanup:Date.now(),pendingSync:[],apiUsage:{}};function a(e,t){return`${e}:${Object.entries(t||{}).sort((([e],[t])=>e.localeCompare(t))).map((([e,t])=>`${e}=${JSON.stringify(t)}`)).join("&")}`}function n(e){return 2*JSON.stringify(e).length}function c(e){return!!e&&Date.now()<e.expiry}function i(){const e=Date.now();let a=0;e-t.lastCleanup<3e5||(t.lastCleanup=e,Object.keys(localStorage).forEach((c=>{if(c.includes(":"))try{const i=JSON.parse(localStorage.getItem(c));i&&i.expiry&&i.expiry<e&&(a+=n(i),localStorage.removeItem(c),t.evictions++)}catch(i){}})),t.size-=a)}function r(a){const c=[];let i=0;if(Object.keys(localStorage).forEach((e=>{if(e.includes(":"))try{const t=JSON.parse(localStorage.getItem(e));if(t&&t.data){const a=n(t);i+=a,c.push({key:e,lastAccess:t.lastAccess||0,accessCount:t.accessCount||0,size:a,expiry:t.expiry||0})}}catch(t){}})),i+a<=e.maxCacheSize)return;"lru"===e.evictionStrategy?c.sort(((e,t)=>e.lastAccess-t.lastAccess)):c.sort(((e,t)=>e.accessCount-t.accessCount));let r=0,o=0;for(const t of c)if(localStorage.removeItem(t.key),r+=t.size,o++,i-r+a<=e.maxCacheSize)break;t.evictions+=o,t.size=i-r}function o(t,a){if(!e.progressiveCache.enabled||!a)return null;const n=e.progressiveCache.criticalDataKeys;return function e(t){if(!t||"object"!==typeof t)return t;if(Array.isArray(t))return t.map((t=>e(t)));const a={};return Object.keys(t).forEach((c=>{if(n.includes(c)||"id"===c||c.endsWith("Id"))a[c]=t[c];else if("object"===typeof t[c]&&null!==t[c]){const n=e(t[c]);n&&(Array.isArray(n)?n.length>0:Object.keys(n).length>0)&&(a[c]=n)}})),Object.keys(a).length>0?a:null}(a)}function s(n,c,i=5){if(!e.backgroundSync.enabled)return;const r=a(n,c),o=t.pendingSync.findIndex((e=>e.key===r));o>=0?(i<t.pendingSync[o].priority&&(t.pendingSync[o].priority=i),t.pendingSync[o].retries=0):(t.pendingSync.push({key:r,type:n,params:c,priority:i,timestamp:Date.now(),retries:0}),t.pendingSync.sort(((e,t)=>e.priority-t.priority)));try{localStorage.setItem("cacheManagerSyncQueue",JSON.stringify(t.pendingSync))}catch(s){}}function l(){e.backgroundSync.enabled&&0!==t.pendingSync.length&&(e.backgroundSync.respectBatteryStatus&&"getBattery"in navigator?navigator.getBattery().then((e=>{(e.charging||e.level>.2)&&h()})).catch((()=>{h()})):h())}function h(){if(0===t.pendingSync.length)return;const a=t.pendingSync[0];if(a.retries>=e.backgroundSync.maxRetries){t.pendingSync.shift();try{localStorage.setItem("cacheManagerSyncQueue",JSON.stringify(t.pendingSync))}catch(n){}l()}else a.retries++,document.dispatchEvent(new CustomEvent("backgroundSync",{detail:{type:a.type,params:a.params,key:a.key,onSuccess:()=>{t.pendingSync.shift();try{localStorage.setItem("cacheManagerSyncQueue",JSON.stringify(t.pendingSync))}catch(n){}setTimeout(l,1e3)},onError:()=>{const e=t.pendingSync.shift();t.pendingSync.push(e);try{localStorage.setItem("cacheManagerSyncQueue",JSON.stringify(t.pendingSync))}catch(n){}setTimeout(l,5e3)}}}))}function u(){try{const e=localStorage.getItem("cacheManagerSyncQueue");e&&(t.pendingSync=JSON.parse(e))}catch(a){}try{const e=localStorage.getItem("cacheManagerApiUsage");e&&(t.apiUsage=JSON.parse(e))}catch(a){}!function(){let e=0;for(let t=0;t<localStorage.length;t++){const c=localStorage.key(t);if(c.startsWith("cache:"))try{const t=JSON.parse(localStorage.getItem(c));if(t&&t.size)e+=t.size;else if(t){e+=n(t)}}catch(a){}}t.size=e}(),navigator.connection&&navigator.connection.addEventListener("change",g),"getBattery"in navigator&&navigator.getBattery().then((e=>{e.addEventListener("chargingchange",p)})).catch((e=>{})),e.backgroundSync.enabled&&setTimeout((()=>{l(),setInterval(l,e.backgroundSync.interval)}),1e4),i()}function g(){if(!e.backgroundSync.enabled||!e.backgroundSync.syncOnNetworkChange)return;navigator.onLine&&l()}function p(t){if(!e.backgroundSync.enabled||!e.backgroundSync.respectBatteryStatus)return;t.target.charging&&l()}return setTimeout(u,500),{set:function(c,s,l,h){if(l)try{const y=a(c,s),d=n(l);t.size+d>e.maxCacheSize&&r(d);let f=h;f||(f=e.ttlConfig[c]||e.defaultTTL);const S={type:c,data:l,timestamp:Date.now(),expiry:Date.now()+1e3*f,size:d,lastAccess:Date.now(),accessCount:0,isCritical:!1,isComplete:!0};if(e.progressiveCache.enabled){const a=o(c,l);if(a){const i=e.progressiveCache.criticalDataTTL[c]||2*f,r={type:c,data:a,timestamp:Date.now(),expiry:Date.now()+1e3*i,size:n(a),lastAccess:Date.now(),accessCount:0,isCritical:!0,isComplete:!1};try{localStorage.setItem(`${y}:critical`,JSON.stringify(r)),t.size+=r.size}catch(u){}}}try{localStorage.setItem(y,JSON.stringify(S)),t.size+=d}catch(u){i();try{localStorage.setItem(y,JSON.stringify(S)),t.size+=d}catch(g){r(2*d);try{localStorage.setItem(y,JSON.stringify(S)),t.size+=d}catch(p){}}}}catch(y){}},get:function(n,i){try{const o=a(n,i);let l=null,h=null,u=!1;try{const e=localStorage.getItem(o);e&&(l=JSON.parse(e))}catch(r){}if(l&&c(l)){l.lastAccess=Date.now(),l.accessCount=(l.accessCount||0)+1;try{localStorage.setItem(o,JSON.stringify(l))}catch(r){}t.hits++;const a=Math.round((l.expiry-Date.now())/1e3);if(a<300){s(n,i,e.progressiveCache.priority[n]||5)}return{data:l.data,fromCache:!0,cacheAge:Math.round((Date.now()-l.timestamp)/1e3),cacheExpiresIn:a,cacheType:"complete"}}if(e.progressiveCache.enabled){try{const e=localStorage.getItem(`${o}:critical`);e&&(h=JSON.parse(e))}catch(r){}if(h&&c(h)){h.lastAccess=Date.now(),h.accessCount=(h.accessCount||0)+1;try{localStorage.setItem(`${o}:critical`,JSON.stringify(h))}catch(r){}t.hits++,u=!0;s(n,i,Math.max(1,(e.progressiveCache.priority[n]||5)-1));const a=Math.round((h.expiry-Date.now())/1e3);return{data:h.data,fromCache:!0,cacheAge:Math.round((Date.now()-h.timestamp)/1e3),cacheExpiresIn:a,cacheType:"critical"}}}t.misses++;return s(n,i,e.progressiveCache.priority[n]||5),null}catch(o){return null}},remove:function(e,t){const n=a(e,t);localStorage.removeItem(n)},clearType:function(e){Object.keys(localStorage).forEach((t=>{t.startsWith(`${e}:`)&&localStorage.removeItem(t)})),function(){let e=0;Object.keys(localStorage).forEach((t=>{if(t.includes(":")){const a=2*localStorage.getItem(t).length;e+=a}})),t.size=e}()},clearAll:function(){Object.keys(localStorage).forEach((e=>{e.includes(":")&&localStorage.removeItem(e)})),t.size=0,t.evictions=0},configure:function(t){e={...e,...t}},getStats:function(){const a=t.hits+t.misses>0?(t.hits/(t.hits+t.misses)*100).toFixed(2):0;return{...t,hitRatio:a,sizeKB:Math.round(t.size/1024),maxSizeKB:Math.round(e.maxCacheSize/1024),usagePercent:(t.size/e.maxCacheSize*100).toFixed(2)}},getCacheEntries:function(){const e=[];return Object.keys(localStorage).forEach((t=>{if(t.includes(":"))try{const a=JSON.parse(localStorage.getItem(t));if(a&&a.type){const[i,r]=t.split(":");e.push({key:t,type:i,params:r,size:n(a),expiry:a.expiry,expiresIn:Math.round((a.expiry-Date.now())/1e3),lastAccess:a.lastAccess,accessCount:a.accessCount||0,isValid:c(a)})}}catch(a){}})),e},addCacheIndicator:function(e,t){if(!e||!t||!t.fromCache)return;const a=document.createElement("div");a.className="cache-indicator";const n=t.cacheAge+t.cacheExpiresIn,c=Math.max(0,Math.min(100,t.cacheExpiresIn/n*100));let i,r;i=t.cacheExpiresIn<60?`${t.cacheExpiresIn}s`:t.cacheExpiresIn<3600?`${Math.floor(t.cacheExpiresIn/60)}m`:`${Math.floor(t.cacheExpiresIn/3600)}h`,r=c>70?"var(--success-color, #28a745)":c>30?"var(--warning-color, #ffc107)":"var(--danger-color, #dc3545)",a.innerHTML=`\n      <div class="cache-icon" style="background-color: ${r};" title="Donn\xe9es en cache - Expire dans ${i}">\n        <i class="fas fa-database"></i>\n      </div>\n    `,e.style.position="relative",e.appendChild(a),a.addEventListener("click",(t=>{t.stopPropagation(),e.dispatchEvent(new CustomEvent("refreshCachedData",{bubbles:!0,detail:{element:e}}))}))},extractCriticalData:o,mergeCacheData:function(e,t){if(!e)return t;if(!t)return e;if(Array.isArray(e)&&Array.isArray(t)){const a={};return e.forEach((e=>{e&&e.id&&(a[e.id]={...e})})),t.map((e=>e&&e.id&&a[e.id]?{...a[e.id],...e}:e))}return"object"===typeof e&&"object"===typeof t?{...e,...t}:t},addToSyncQueue:s,processBackgroundSync:l,checkApiRateLimit:function(a){if(!e.apiRateLimit.enabled)return!0;const n=(new Date).toISOString().split("T")[0];if(!t.apiUsage[n]){t.apiUsage[n]={};const e=Object.keys(t.apiUsage).sort();for(;e.length>7;)delete t.apiUsage[e.shift()]}t.apiUsage[n][a]||(t.apiUsage[n][a]=0);const c=e.apiRateLimit.quotaPerApi[a]||1e3;if(t.apiUsage[n][a]>=c-Math.floor(c*e.apiRateLimit.conserveQuota))return!1;t.apiUsage[n][a]++;try{localStorage.setItem("cacheManagerApiUsage",JSON.stringify(t.apiUsage))}catch(i){}return!0},init:u}}();window.CacheManager=CacheManager,document.addEventListener("backgroundSync",(function(e){const{type:t,params:a,key:n,onSuccess:c,onError:i}=e.detail;switch(t){case"weather":window.weather&&"function"===typeof window.weather.fetchWeatherData?window.weather.fetchWeatherData(a.lat,a.lon).then((()=>c())).catch((()=>i())):i();break;case"forecast":window.weather&&"function"===typeof window.weather.fetchForecast?window.weather.fetchForecast(a.lat,a.lon).then((()=>c())).catch((()=>i())):i();break;case"routes":window.router&&"function"===typeof window.router.fetchRoute?window.router.fetchRoute(a.start,a.end,a.profile).then((()=>c())).catch((()=>i())):i();break;case"stravaActivities":window.strava&&"function"===typeof window.strava.fetchActivities?window.strava.fetchActivities().then((()=>c())).catch((()=>i())):i();break;case"stravaAthleteStats":window.strava&&"function"===typeof window.strava.fetchAthleteStats?window.strava.fetchAthleteStats().then((()=>c())).catch((()=>i())):i();break;default:i()}})),function(){const e=document.createElement("style");e.textContent="\n    .cache-indicator {\n      position: absolute;\n      top: 8px;\n      right: 8px;\n      z-index: 10;\n    }\n    \n    .cache-icon {\n      width: 24px;\n      height: 24px;\n      border-radius: 50%;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      color: white;\n      font-size: 12px;\n      cursor: pointer;\n      transition: transform 0.2s;\n      box-shadow: 0 1px 3px rgba(0,0,0,0.2);\n    }\n    \n    .cache-icon:hover {\n      transform: scale(1.1);\n    }\n  ",document.head.appendChild(e)}();