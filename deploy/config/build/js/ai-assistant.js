const assistantConfig={defaultPrompts:{training:"Que dois-je faire comme entra\xeenement cycliste cette semaine pour progresser ?",nutrition:"Quels aliments et boissons sont recommand\xe9s avant, pendant et apr\xe8s une sortie v\xe9lo ?",routes:"Quels sont les meilleurs itin\xe9raires cyclistes dans la r\xe9gion Grand Est ?",equipment:"Quel \xe9quipement est recommand\xe9 pour le cyclisme en montagne dans les Vosges ?",recovery:"Comment optimiser ma r\xe9cup\xe9ration apr\xe8s une sortie v\xe9lo intensive ?"},contextProviders:{weather:()=>window.weatherModule?window.weatherModule.getCurrentWeatherContext():null,strava:()=>window.stravaIntegration?window.stravaIntegration.getAthleteContext():null,location:()=>({region:"Grand Est",majorAreas:["Vosges","Alsace","Lorraine","Champagne-Ardenne"],famousCyclingSpots:["Col du Grand Ballon","Col de la Schlucht","Planche des Belles Filles"]})},conversationHistory:[],maxHistoryLength:10};function initAIAssistant(e,n,t,s){const a=document.getElementById(e),o=document.getElementById(n),i=document.getElementById(t),r=document.getElementById(s);a&&o&&i&&(initChatContainer(a),i.addEventListener("click",(()=>{const n=o.value.trim();n&&(sendMessage(n,e),o.value="")})),o.addEventListener("keypress",(n=>{if("Enter"===n.key){const t=o.value.trim();t&&(sendMessage(t,e),o.value=""),n.preventDefault()}})),r&&initSuggestions(r,e),addSystemMessage("Bonjour, je suis votre assistant cyclisme pour la r\xe9gion Grand Est ! Je peux vous donner des conseils d'entra\xeenement, des recommandations nutritionnelles, des id\xe9es d'itin\xe9raires ou r\xe9pondre \xe0 vos questions sur le cyclisme. Comment puis-je vous aider aujourd'hui ?",e))}function initChatContainer(e){e.innerHTML="";const n=document.createElement("div");n.className="chat-header",n.innerHTML='\n    <div class="chat-title">\n      <i class="fas fa-robot"></i>\n      <h3>Assistant Cyclisme</h3>\n    </div>\n  ';const t=document.createElement("div");t.className="chat-body";const s=document.createElement("div");s.className="chat-messages",t.appendChild(s),e.appendChild(n),e.appendChild(t)}function initSuggestions(e,n){e.innerHTML="";const t=document.createElement("h3");t.textContent="Suggestions",e.appendChild(t);const s=document.createElement("div");s.className="suggestion-list",Object.entries(assistantConfig.defaultPrompts).forEach((([e,t])=>{const a=document.createElement("div");a.className="suggestion-item",a.textContent=t,a.addEventListener("click",(()=>{sendMessage(t,n)})),s.appendChild(a)})),e.appendChild(s)}function sendMessage(e,n){addUserMessage(e,n);const t=addLoadingIndicator(n),s={};Object.entries(assistantConfig.contextProviders).forEach((([e,n])=>{const t=n();t&&(s[e]=t)})),s.history=assistantConfig.conversationHistory.slice(-assistantConfig.maxHistoryLength),generateAIResponse(e,s).then((s=>{removeLoadingIndicator(t,n),addAssistantMessage(s,n),assistantConfig.conversationHistory.push({role:"user",content:e}),assistantConfig.conversationHistory.push({role:"assistant",content:s}),assistantConfig.conversationHistory.length>2*assistantConfig.maxHistoryLength&&(assistantConfig.conversationHistory=assistantConfig.conversationHistory.slice(2*-assistantConfig.maxHistoryLength))})).catch((e=>{removeLoadingIndicator(t,n),addSystemMessage("D\xe9sol\xe9, une erreur est survenue lors de la g\xe9n\xe9ration de la r\xe9ponse. Veuillez r\xe9essayer.",n)}))}function generateAIResponse(e,n){return fetch("/api/ai/generate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:e,context:n})}).then((e=>{if(!e.ok)throw new Error("Erreur lors de la g\xe9n\xe9ration de la r\xe9ponse");return e.json()})).then((e=>{if(e.success&&e.data&&e.data.response)return e.data.response;throw new Error("R\xe9ponse invalide de l'API")}))}function generateRouteRecommendation(e){return fetch("/api/ai/route-recommendation",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({preferences:e})}).then((e=>{if(!e.ok)throw new Error("Erreur lors de la g\xe9n\xe9ration de la recommandation");return e.json()})).then((e=>{if(e.success&&e.data)return e.data;throw new Error("R\xe9ponse invalide de l'API")}))}function generateTrainingPlan(e,n){return fetch("/api/ai/training-plan",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({athleteData:e,goals:n})}).then((e=>{if(!e.ok)throw new Error("Erreur lors de la g\xe9n\xe9ration du plan d'entra\xeenement");return e.json()})).then((e=>{if(e.success&&e.data)return e.data;throw new Error("R\xe9ponse invalide de l'API")}))}function addUserMessage(e,n){const t=document.createElement("div");t.className="chat-message user-message",t.innerHTML=`\n    <div class="message-content">\n      <p>${formatMessageText(e)}</p>\n    </div>\n    <div class="message-avatar">\n      <i class="fas fa-user"></i>\n    </div>\n  `,appendMessageToChat(t,n)}function addAssistantMessage(e,n){const t=document.createElement("div");t.className="chat-message assistant-message",t.innerHTML=`\n    <div class="message-avatar">\n      <i class="fas fa-robot"></i>\n    </div>\n    <div class="message-content">\n      <p>${formatMessageText(e)}</p>\n    </div>\n  `,appendMessageToChat(t,n)}function addSystemMessage(e,n){const t=document.createElement("div");t.className="chat-message system-message",t.innerHTML=`\n    <div class="message-content">\n      <p>${formatMessageText(e)}</p>\n    </div>\n  `,appendMessageToChat(t,n)}function addLoadingIndicator(e){const n="loading-"+Date.now(),t=document.createElement("div");return t.className="chat-message assistant-message loading-message",t.id=n,t.innerHTML='\n    <div class="message-avatar">\n      <i class="fas fa-robot"></i>\n    </div>\n    <div class="message-content">\n      <div class="typing-indicator">\n        <span></span>\n        <span></span>\n        <span></span>\n      </div>\n    </div>\n  ',appendMessageToChat(t,e),n}function removeLoadingIndicator(e,n){const t=document.getElementById(e);t&&t.remove()}function appendMessageToChat(e,n){const t=document.getElementById(n);if(!t)return;const s=t.querySelector(".chat-messages");if(s)s.appendChild(e),s.scrollTop=s.scrollHeight;else{const n=t.querySelector(".chat-body");if(n){const t=document.createElement("div");t.className="chat-messages",t.appendChild(e),n.appendChild(t)}}}function formatMessageText(e){let n=e.replace(/(https?:\/\/[^\s]+)/g,'<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');return n=n.replace(/\n/g,"<br>"),n}window.aiAssistant={initAIAssistant:initAIAssistant,generateRouteRecommendation:generateRouteRecommendation,generateTrainingPlan:generateTrainingPlan};