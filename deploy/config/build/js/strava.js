let isAuthenticated=!1,athlete=null;function initStrava(t,e,a){checkAuthStatus().then((i=>{isAuthenticated=i.isAuthenticated,athlete=i.athlete,updateAuthUI(t),isAuthenticated&&(fetchActivities(e),fetchAthleteStats(a))})).catch((t=>{}));const i=document.getElementById(t);i&&i.addEventListener("click",(()=>{isAuthenticated?logout().then((()=>{isAuthenticated=!1,athlete=null,updateAuthUI(t),clearContainer(e),clearContainer(a)})).catch((t=>{})):window.location.href="/api/strava/auth"}))}function checkAuthStatus(){return fetch("/api/strava/status").then((t=>{if(!t.ok)throw new Error("Erreur lors de la v\xe9rification de l'\xe9tat d'authentification");return t.json()})).then((t=>({isAuthenticated:t.isAuthenticated,athlete:t.athlete})))}function updateAuthUI(t){const e=document.getElementById(t);if(e)if(isAuthenticated&&athlete){e.textContent="D\xe9connexion Strava",e.classList.remove("strava-connect"),e.classList.add("strava-disconnect");const t=document.getElementById("athlete-info");t&&(t.innerHTML=`\n        <div class="athlete-profile">\n          <img src="${athlete.profile}" alt="${athlete.firstname} ${athlete.lastname}" class="athlete-avatar">\n          <div class="athlete-details">\n            <h3>${athlete.firstname} ${athlete.lastname}</h3>\n            <p>${athlete.city}, ${athlete.country}</p>\n          </div>\n        </div>\n      `)}else{e.textContent="Se connecter avec Strava",e.classList.remove("strava-disconnect"),e.classList.add("strava-connect");const t=document.getElementById("athlete-info");t&&(t.innerHTML='\n        <div class="strava-promo">\n          <h3>Connectez-vous \xe0 Strava</h3>\n          <p>Synchronisez vos activit\xe9s cyclistes et analysez vos performances</p>\n        </div>\n      ')}}function fetchActivities(t,e=1,a=10){return fetch(`/api/strava/activities?page=${e}&per_page=${a}`).then((t=>{if(!t.ok)throw new Error("Erreur lors de la r\xe9cup\xe9ration des activit\xe9s");return t.json()})).then((e=>{if(e.success&&e.data)return displayActivities(t,e.data),e.data;throw new Error("Donn\xe9es d'activit\xe9s invalides")}))}function displayActivities(t,e){const a=document.getElementById(t);if(!a)return;a.innerHTML="";const i=document.createElement("h2");if(i.textContent="Vos activit\xe9s r\xe9centes",a.appendChild(i),!e||0===e.length){const t=document.createElement("p");return t.className="empty-activities",t.textContent="Aucune activit\xe9 r\xe9cente trouv\xe9e",void a.appendChild(t)}const n=document.createElement("ul");n.className="activity-list",e.forEach((t=>{const e=document.createElement("li");e.className="activity-item";const a=(t.distance/1e3).toFixed(2),i=Math.round(t.total_elevation_gain),s=formatDuration(t.moving_time),d=new Date(t.start_date).toLocaleDateString("fr-FR",{weekday:"long",year:"numeric",month:"long",day:"numeric"});let l="#1F497D";"Ride"===t.type?l="#FF6B35":"Run"===t.type?l="#4CAF50":"Swim"===t.type&&(l="#3A6EA5"),e.innerHTML=`\n      <div class="activity-header" style="border-left: 4px solid ${l}">\n        <h3>${t.name}</h3>\n        <span class="activity-date">${d}</span>\n      </div>\n      <div class="activity-body">\n        <div class="activity-stats">\n          <div class="stat">\n            <i class="fas fa-route"></i>\n            <span>${a} km</span>\n          </div>\n          <div class="stat">\n            <i class="fas fa-mountain"></i>\n            <span>${i} m</span>\n          </div>\n          <div class="stat">\n            <i class="fas fa-stopwatch"></i>\n            <span>${s}</span>\n          </div>\n        </div>\n        <div class="activity-details">\n          <button class="view-activity" data-id="${t.id}">\n            Voir les d\xe9tails\n          </button>\n        </div>\n      </div>\n    `,n.appendChild(e);e.querySelector(".view-activity").addEventListener("click",(()=>{fetchActivityDetails(t.id).then((t=>{if(displayActivityDetails(t),t.start_latlng&&t.end_latlng&&window.cyclingMap){const e=[t.start_latlng[1],t.start_latlng[0]],a=[t.end_latlng[1],t.end_latlng[0]];window.cyclingMap.calculateRoute(e,a)}})).catch((t=>{}))}))})),a.appendChild(n);const s=document.createElement("button");s.className="load-more-activities",s.textContent="Charger plus d'activit\xe9s",s.addEventListener("click",(()=>{const a=Math.ceil(e.length/perPage)+1;fetchActivities(t,a,perPage)})),a.appendChild(s)}function fetchActivityDetails(t){return fetch(`/api/strava/activities/${t}`).then((t=>{if(!t.ok)throw new Error("Erreur lors de la r\xe9cup\xe9ration des d\xe9tails de l'activit\xe9");return t.json()})).then((t=>{if(t.success&&t.data)return t.data;throw new Error("Donn\xe9es de d\xe9tails d'activit\xe9 invalides")}))}function displayActivityDetails(t){let e=document.getElementById("activity-details-modal");e||(e=document.createElement("div"),e.id="activity-details-modal",e.className="modal",document.body.appendChild(e));const a=(t.distance/1e3).toFixed(2),i=Math.round(t.total_elevation_gain),n=formatDuration(t.moving_time),s=(3.6*t.average_speed).toFixed(1),d=(3.6*t.max_speed).toFixed(1),l=new Date(t.start_date),c=l.toLocaleDateString("fr-FR",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),o=l.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"});e.innerHTML=`\n    <div class="modal-content">\n      <div class="modal-header">\n        <h2>${t.name}</h2>\n        <span class="close-modal">&times;</span>\n      </div>\n      <div class="modal-body">\n        <div class="activity-date-time">\n          <p><i class="fas fa-calendar"></i> ${c} \xe0 ${o}</p>\n        </div>\n        <div class="activity-stats-grid">\n          <div class="stat-card">\n            <div class="stat-value">${a} km</div>\n            <div class="stat-label">Distance</div>\n          </div>\n          <div class="stat-card">\n            <div class="stat-value">${i} m</div>\n            <div class="stat-label">D\xe9nivel\xe9</div>\n          </div>\n          <div class="stat-card">\n            <div class="stat-value">${n}</div>\n            <div class="stat-label">Dur\xe9e</div>\n          </div>\n          <div class="stat-card">\n            <div class="stat-value">${s} km/h</div>\n            <div class="stat-label">Vitesse moyenne</div>\n          </div>\n          <div class="stat-card">\n            <div class="stat-value">${d} km/h</div>\n            <div class="stat-label">Vitesse max</div>\n          </div>\n          <div class="stat-card">\n            <div class="stat-value">${t.calories||"\u2014"}</div>\n            <div class="stat-label">Calories</div>\n          </div>\n        </div>\n        \n        <div class="activity-description">\n          ${t.description?`<p>${t.description}</p>`:""}\n        </div>\n        \n        <div class="activity-map" id="activity-detail-map"></div>\n        \n        ${t.photos&&t.photos.primary?`\n          <div class="activity-photo">\n            <img src="${t.photos.primary.urls[600]}" alt="Photo de l'activit\xe9">\n          </div>\n        `:""}\n      </div>\n    </div>\n  `,e.style.display="block";if(e.querySelector(".close-modal").addEventListener("click",(()=>{e.style.display="none"})),window.addEventListener("click",(t=>{t.target===e&&(e.style.display="none")})),t.map&&t.map.polyline&&window.mapboxgl){const e=new mapboxgl.Map({container:"activity-detail-map",style:"mapbox://styles/mapbox/outdoors-v12",center:t.start_latlng?[t.start_latlng[1],t.start_latlng[0]]:[6.877,48.1],zoom:11});e.on("load",(()=>{const a=decodePolyline(t.map.polyline);if(e.addSource("activity-route",{type:"geojson",data:{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:a.map((t=>[t[1],t[0]]))}}}),e.addLayer({id:"activity-route",type:"line",source:"activity-route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#FF6B35","line-width":4}}),a.length>0){const t=document.createElement("div");t.className="marker start-marker",t.style.backgroundColor="#4CAF50",t.style.width="15px",t.style.height="15px",t.style.borderRadius="50%",new mapboxgl.Marker(t).setLngLat([a[0][1],a[0][0]]).addTo(e);const i=document.createElement("div");i.className="marker end-marker",i.style.backgroundColor="#F44336",i.style.width="15px",i.style.height="15px",i.style.borderRadius="50%",new mapboxgl.Marker(i).setLngLat([a[a.length-1][1],a[a.length-1][0]]).addTo(e);const n=a.reduce(((t,e)=>t.extend([e[1],e[0]])),new mapboxgl.LngLatBounds([a[0][1],a[0][0]],[a[0][1],a[0][0]]));e.fitBounds(n,{padding:40})}}))}}function fetchAthleteStats(t){return fetch("/api/strava/stats").then((t=>{if(!t.ok)throw new Error("Erreur lors de la r\xe9cup\xe9ration des statistiques");return t.json()})).then((e=>{if(e.success&&e.data)return displayAthleteStats(t,e.data),e.data;throw new Error("Donn\xe9es de statistiques invalides")}))}function displayAthleteStats(t,e){const a=document.getElementById(t);if(!a)return;const i=e.all_ride_totals||{},n=e.recent_ride_totals||{},s=i.count||0,d=((i.distance||0)/1e3).toFixed(0),l=Math.round(i.elevation_gain||0),c=formatDuration(i.moving_time||0),o=n.count||0,r=((n.distance||0)/1e3).toFixed(0),v=Math.round(n.elevation_gain||0);a.innerHTML=`\n    <h2>Vos statistiques</h2>\n    <div class="stats-grid">\n      <div class="stats-card total-stats">\n        <h3>Total de vos activit\xe9s</h3>\n        <div class="stats-content">\n          <div class="stat-item">\n            <div class="stat-value">${s}</div>\n            <div class="stat-label">Sorties</div>\n          </div>\n          <div class="stat-item">\n            <div class="stat-value">${d}</div>\n            <div class="stat-label">Kilom\xe8tres</div>\n          </div>\n          <div class="stat-item">\n            <div class="stat-value">${l}</div>\n            <div class="stat-label">D\xe9nivel\xe9 (m)</div>\n          </div>\n          <div class="stat-item">\n            <div class="stat-value">${c}</div>\n            <div class="stat-label">Temps total</div>\n          </div>\n        </div>\n      </div>\n      \n      <div class="stats-card recent-stats">\n        <h3>Activit\xe9s des 4 derni\xe8res semaines</h3>\n        <div class="stats-content">\n          <div class="stat-item">\n            <div class="stat-value">${o}</div>\n            <div class="stat-label">Sorties</div>\n          </div>\n          <div class="stat-item">\n            <div class="stat-value">${r}</div>\n            <div class="stat-label">Kilom\xe8tres</div>\n          </div>\n          <div class="stat-item">\n            <div class="stat-value">${v}</div>\n            <div class="stat-label">D\xe9nivel\xe9 (m)</div>\n          </div>\n        </div>\n      </div>\n    </div>\n  `}function logout(){return fetch("/api/strava/logout",{method:"POST",headers:{"Content-Type":"application/json"}}).then((t=>{if(!t.ok)throw new Error("Erreur lors de la d\xe9connexion");return t.json()}))}function clearContainer(t){const e=document.getElementById(t);e&&(e.innerHTML="")}function formatDuration(t){const e=Math.floor(t/3600),a=Math.floor(t%3600/60);return e>0?`${e}h ${a}m`:`${a}m`}function decodePolyline(t){const e=[];let a=0;const i=t.length;let n=0,s=0;for(;a<i;){let i,d=1,l=0;do{i=t.charCodeAt(a++)-63,d+=(31&i)<<l,l+=5}while(i>=32);n+=1&d?~(d>>1):d>>1,d=1,l=0;do{i=t.charCodeAt(a++)-63,d+=(31&i)<<l,l+=5}while(i>=32);s+=1&d?~(d>>1):d>>1,e.push([1e-5*n,1e-5*s])}return e}window.stravaIntegration={initStrava:initStrava,fetchActivities:fetchActivities,fetchAthleteStats:fetchAthleteStats};