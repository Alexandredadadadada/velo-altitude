const weatherCache={current:null,forecast:null,lastUpdate:null};function initWeather(e,t,n=[48.6833,6.2]){fetchCurrentWeather(n[0],n[1]).then((t=>{updateWeatherWidget(e,t),weatherCache.current=t,weatherCache.lastUpdate=new Date})).catch((e=>{})),fetchWeatherForecast(n[0],n[1]).then((e=>{displayWeatherForecast(t,e),weatherCache.forecast=e})).catch((e=>{})),setInterval((()=>{fetchCurrentWeather(n[0],n[1]).then((t=>{updateWeatherWidget(e,t),weatherCache.current=t,weatherCache.lastUpdate=new Date})),fetchWeatherForecast(n[0],n[1]).then((e=>{displayWeatherForecast(t,e),weatherCache.forecast=e}))}),18e5)}function fetchCurrentWeather(e,t){return fetch(`/api/weather/current?lat=${e}&lon=${t}`).then((e=>{if(!e.ok)throw new Error("Erreur lors de la r\xe9cup\xe9ration des donn\xe9es m\xe9t\xe9o");return e.json()})).then((e=>{if(e.success&&e.data)return e.data;throw new Error("Donn\xe9es m\xe9t\xe9o invalides")}))}function fetchWeatherForecast(e,t){return fetch(`/api/weather/forecast?lat=${e}&lon=${t}`).then((e=>{if(!e.ok)throw new Error("Erreur lors de la r\xe9cup\xe9ration des pr\xe9visions m\xe9t\xe9o");return e.json()})).then((e=>{if(e.success&&e.data)return e.data;throw new Error("Donn\xe9es de pr\xe9vision invalides")}))}function updateWeatherWidget(e,t){const n=document.getElementById(e);if(!n)return;const a=Math.round(t.main.temp),i=Math.round(t.main.feels_like),r=t.weather[0].description,s=t.weather[0].icon,c=(3.6*t.wind.speed).toFixed(1),o=getWindDirection(t.wind.deg),d=t.main.humidity,l=(t.main.pressure,(t.visibility/1e3).toFixed(1),evaluateCyclingConditions(t));n.innerHTML=`\n    <div class="weather-widget ${l?"weather-good":"weather-warning"}">\n      <div class="weather-main">\n        <div class="weather-icon">\n          <img src="https://openweathermap.org/img/wn/${s}@2x.png" alt="${r}">\n        </div>\n        <div class="weather-info">\n          <div class="weather-temp">${a}\xb0C</div>\n          <div class="weather-desc">${r}</div>\n        </div>\n      </div>\n      <div class="weather-details">\n        <div class="weather-detail">\n          <i class="fas fa-thermometer-half"></i>\n          <span>Ressenti: ${i}\xb0C</span>\n        </div>\n        <div class="weather-detail">\n          <i class="fas fa-wind"></i>\n          <span>Vent: ${c} km/h ${o}</span>\n        </div>\n        <div class="weather-detail">\n          <i class="fas fa-tint"></i>\n          <span>Humidit\xe9: ${d}%</span>\n        </div>\n      </div>\n      <div class="weather-cycling-advice">\n        ${l?'<span class="good-condition"><i class="fas fa-bicycle"></i> Conditions favorables pour le cyclisme</span>':'<span class="poor-condition"><i class="fas fa-exclamation-triangle"></i> Conditions difficiles pour le cyclisme</span>'}\n      </div>\n    </div>\n  `}function displayWeatherForecast(e,t){const n=document.getElementById(e);if(!n)return;n.innerHTML="";const a=document.createElement("h2");a.textContent="Pr\xe9visions m\xe9t\xe9o",n.appendChild(a);const i=document.createElement("div");i.className="forecast-container";const r=groupForecastsByDay(t.list);Object.entries(r).forEach((([e,t])=>{const n=document.createElement("div");n.className="forecast-day-card";const a=new Date(e),r=a.toLocaleDateString("fr-FR",{weekday:"long"}),s=a.toLocaleDateString("fr-FR",{day:"numeric",month:"long"}),c=Math.round(t.reduce(((e,t)=>e+t.main.temp),0)/t.length),o=t.find((e=>{const t=new Date(1e3*e.dt).getHours();return t>=11&&t<=14}))||t[0],d=o.weather[0].icon,l=o.weather[0].description,h=evaluateCyclingDay(t);let u="",p="";h>7?(u="Excellente journ\xe9e pour le v\xe9lo !",p="cycling-excellent"):h>5?(u="Bonne journ\xe9e pour le v\xe9lo",p="cycling-good"):h>3?(u="Conditions moyennes pour le v\xe9lo",p="cycling-average"):(u="Conditions d\xe9favorables pour le v\xe9lo",p="cycling-poor"),n.innerHTML=`\n      <div class="forecast-day-header">\n        <div class="forecast-day-date">\n          <div class="day-name">${r}</div>\n          <div class="day-date">${s}</div>\n        </div>\n        <div class="forecast-day-icon">\n          <img src="https://openweathermap.org/img/wn/${d}@2x.png" alt="${l}">\n        </div>\n        <div class="forecast-day-temp">\n          ${c}\xb0C\n        </div>\n      </div>\n      <div class="forecast-day-details">\n        <div class="hourly-forecast">\n          ${t.map((e=>{const t=new Date(1e3*e.dt).getHours(),n=Math.round(e.main.temp);return`\n              <div class="hourly-item">\n                <div class="hourly-time">${t}h</div>\n                <div class="hourly-icon">\n                  <img src="https://openweathermap.org/img/wn/${e.weather[0].icon}.png" alt="">\n                </div>\n                <div class="hourly-temp">${n}\xb0C</div>\n              </div>\n            `})).join("")}\n        </div>\n      </div>\n      <div class="forecast-cycling-advice ${p}">\n        <i class="fas fa-bicycle"></i> ${u}\n      </div>\n    `,i.appendChild(n)})),n.appendChild(i)}function groupForecastsByDay(e){const t={};return e.forEach((e=>{const n=new Date(1e3*e.dt).toISOString().split("T")[0];t[n]||(t[n]=[]),t[n].push(e)})),t}function evaluateCyclingConditions(e){const t=[200,201,202,230,231,232,300,301,302,310,311,312,313,314,321,500,501,502,503,504,511,520,521,522,531].includes(e.weather[0].id),n=[600,601,602,611,612,613,615,616,620,621,622].includes(e.weather[0].id),a=[771,781].includes(e.weather[0].id),i=e.main.temp<5,r=e.main.temp>32,s=e.wind.speed>8;return!(t||n||a||i||r||s)}function evaluateCyclingDay(e){let t=10;t-=e.filter((e=>[200,201,202,230,231,232,300,301,302,310,311,312,313,314,321,500,501,502,503,504,511,520,521,522,531].includes(e.weather[0].id))).length/e.length*5;const n=e.reduce(((e,t)=>e+t.main.temp),0)/e.length;n<5?t-=.5*(5-n):n>30&&(t-=.5*(n-30));const a=e.reduce(((e,t)=>e+t.wind.speed),0)/e.length;return a>5&&(t-=.5*(a-5)),Math.max(0,Math.min(10,t))}function getWindDirection(e){return["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSO","SO","OSO","O","ONO","NO","NNO"][Math.round(e/22.5)%16]}window.weatherModule={initWeather:initWeather,fetchCurrentWeather:fetchCurrentWeather,fetchWeatherForecast:fetchWeatherForecast,updateWeatherWidget:updateWeatherWidget,displayWeatherForecast:displayWeatherForecast};